<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital - Sistema de Gestion de Camas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">Sistema de Gestion de Camas</h1>
                    <div class="flex items-center gap-4 mt-2">
                        <label class="text-blue-100 text-sm">Hospital:</label>
                        <select id="hospital-selector" onchange="cambiarHospital()" 
                                class="bg-white text-blue-900 px-4 py-2 rounded-lg font-semibold shadow">
                            <option value="PMONTT">Hospital Puerto Montt</option>
                            <option value="CALBUCO">Hospital Calbuco</option>
                            <option value="LLANHUE">Hospital Llanquihue</option>
                        </select>
                        
                        <div id="filtro-servicio-container" class="flex items-center gap-2">
                            <label class="text-blue-100 text-sm">Filtrar por servicio:</label>
                            <select id="servicio-selector" onchange="filtrarPorServicio()" 
                                    class="bg-white text-blue-900 px-4 py-2 rounded-lg font-semibold shadow">
                                <option value="">Todos los servicios</option>
                                <option value="uci">UCI</option>
                                <option value="uti">UTI</option>
                                <option value="medicina">Medicina</option>
                                <option value="cirugia">Cirugia</option>
                                <option value="gineco">Ginecologia</option>
                                <option value="aislamiento">Aislamiento</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center gap-2 ml-4">
                            <span class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
                            <span class="text-xs text-blue-100">Asignacion automatica activa</span>
                        </div>
                    </div>
                </div>
                <button onclick="abrirFormularioNuevoPaciente()" 
                        class="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 shadow-lg flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Registrar Paciente
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div id="estadisticas-rapidas" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
        </div>

        <div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex justify-between items-center">
        <h3 class="font-semibold text-gray-700">Leyenda de Estados:</h3>
        <div class="flex gap-4 text-sm flex-wrap">
            <span class="flex items-center"><span class="w-4 h-4 bg-gray-200 rounded mr-2"></span> Libre</span>
            <span class="flex items-center"><span class="w-4 h-4 bg-green-500 rounded mr-2"></span> Ocupada</span>
            <span class="flex items-center"><span class="w-4 h-4 bg-yellow-400 rounded mr-2"></span> Pendiente Traslado</span>
            <span class="flex items-center"><span class="w-4 h-4 bg-orange-400 rounded mr-2"></span> En Traslado / Aceptado en Destino</span>
            <span class="flex items-center"><span class="w-4 h-4 bg-blue-400 rounded mr-2"></span> Alta Sugerida</span>
            <span class="flex items-center"><span class="w-3 h-3 bg-purple-600 rounded-full mr-2"></span> Caso Especial (no puede dar alta)</span>
        </div>
    </div>
</div>

        <div id="servicios-container" class="space-y-6">
        </div>

        <div class="bg-white rounded-lg shadow p-6 mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Pacientes que Requieren Nueva Cama</h2>
                <div class="flex items-center gap-2">
                    <span id="contador-cola" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">0 pacientes</span>
                    <button onclick="sincronizarCola()" 
                            class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300">
                        Sincronizar
                    </button>
                </div>
            </div>
            <p class="text-sm text-gray-500 mb-4">
                Los pacientes se ordenan automaticamente por prioridad. El sistema asigna camas de forma continua.
            </p>
            <div id="pacientes-espera-container">
            </div>
        </div>
    </div>

    <div id="modal-ingresar" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-title" class="text-2xl font-bold">Registrar Nuevo Paciente</h2>
                    <button onclick="closeModal('modal-ingresar')" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form onsubmit="submitPacienteForm(event)" id="form-paciente" class="space-y-4">
                    <input type="hidden" id="paciente-id" name="paciente_id" value="">
                    <input type="hidden" id="es-reevaluacion" name="es_reevaluacion" value="false">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nombre Completo *</label>
                            <input type="text" id="nombre" name="nombre" required class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">RUN *</label>
                            <input type="text" id="run" name="run" required placeholder="12345678-9" 
                                   pattern="[0-9]{7,8}-[0-9Kk]" 
                                   title="Formato: 12345678-9"
                                   class="w-full border rounded px-3 py-2">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Sexo *</label>
                        <div class="flex gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" id="sexo_hombre" name="sexo" value="hombre" required class="rounded">
                                <span class="text-sm font-medium">Hombre</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" id="sexo_mujer" name="sexo" value="mujer" required class="rounded">
                                <span class="text-sm font-medium">Mujer</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Edad (anos) *</label>
                        <input type="number" id="edad" name="edad" required min="0" max="120" 
                               class="w-full border rounded px-3 py-2"
                               placeholder="Ej: 45">
                        <p class="text-xs text-gray-500 mt-1">El sistema determina automaticamente el rango etario</p>
                    </div>

                    <div id="div-embarazada" class="hidden">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="es_embarazada" name="es_embarazada" class="rounded">
                            <span class="text-sm font-medium">Paciente embarazada?</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Diagnostico</label>
                        <textarea id="diagnostico" name="diagnostico" rows="2" 
                                  class="w-full border rounded px-3 py-2" 
                                  placeholder="Ingrese el diagnostico del paciente..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Tipo de Enfermedad *</label>
                        <select id="enfermedad" name="enfermedad" required class="w-full border rounded px-3 py-2">
                            <option value="">Seleccionar...</option>
                            <option value="medica">Medica</option>
                            <option value="quirurgica">Quirurgica</option>
                            <option value="traumatologica">Traumatologica</option>
                            <option value="neurologica">Neurologica</option>
                            <option value="geriatrica">Geriatrica</option>
                            <option value="urologica">Urologica</option>
                            <option value="ginecologica">Ginecologica</option>
                            <option value="obstetrica">Obstetrica</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Tipo de Aislamiento</label>
                        <select id="aislamiento" name="aislamiento" class="w-full border rounded px-3 py-2">
                            <option value="ninguno">Ninguno</option>
                            <option value="contacto">Contacto (puede compartir sala)</option>
                            <option value="gotitas">Gotitas (puede compartir sala)</option>
                            <option value="aereo">Aereo (cama individual)</option>
                            <option value="ambiente_protegido">Ambiente protegido (cama individual)</option>
                            <option value="aislamiento_especial" title="C. difficile, KPC, otros">Aislamiento especial (cama individual)</option>
                        </select>
                    </div>

                    <div class="border rounded p-4 bg-purple-50">
                        <label class="block text-sm font-medium mb-2 text-purple-800">Casos Especiales (Bloquean Alta Automatica)</label>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="caso_sociosanitario" name="caso_sociosanitario" class="rounded">
                                <span class="text-sm font-medium">Caso Sociosanitario</span>
                                <span class="text-xs text-gray-600 ml-2">(Paciente que requiere apoyo social antes del alta)</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="espera_cardio" name="espera_cardio" class="rounded">
                                <span class="text-sm font-medium">En espera de Cardiocirugia</span>
                                <span class="text-xs text-gray-600 ml-2">(Paciente esperando procedimiento cardioquirurgico)</span>
                            </label>
                        </div>
                        <p class="text-xs text-purple-700 mt-2">
                            Los pacientes con casos especiales NO pueden ser dados de alta automaticamente, 
                            incluso si no tienen requerimientos clinicos.
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Requerimientos Clinicos</label>
                        <div class="border rounded p-4 space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-xs text-gray-600 mb-2 font-semibold">
                                Requerimientos que NO definen cama ni necesidad de hospitalizacion:
                            </p>
                            <div class="grid grid-cols-2 gap-2 bg-gray-50 p-2 rounded mb-4">
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="kinesioterapia_respiratoria" class="rounded">
                                    <span>Kinesioterapia respiratoria</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="curaciones_heridas" class="rounded">
                                    <span>Curaciones de heridas</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="control_examenes_sangre_1vez" class="rounded">
                                    <span>Control con examen de sangre (1 vez)</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="tratamiento_endovenoso_2menos" class="rounded">
                                    <span>Tratamiento endovenoso por 2 veces o menos</span>
                                </label>
                            </div>
                            
                            <p class="text-xs text-gray-600 mb-2 mt-4">Baja Complejidad (1 punto c/u):</p>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="tratamiento_endovenoso" class="rounded">
                                    <span>Tratamiento endovenoso por 3 veces o mas</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="control_examenes_sangre_2mas" class="rounded">
                                    <span>Control con examen de sangre 2 veces o mas</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_naricera" class="rounded">
                                    <span>Oxigeno por naricera</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="dolor_intenso" class="rounded">
                                    <span>Dolor intenso (EVA mayor o igual 7)</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_mascarilla_multiventuri" class="rounded">
                                    <span>Oxigeno por mascarilla multiventuri</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="curaciones_alta_complejidad" class="rounded">
                                    <span>Curaciones de alta complejidad</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="aspiracion_invasiva" class="rounded">
                                    <span>Aspiracion invasiva de secreciones bronquiales</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="observacion_riesgo_compromiso" class="rounded">
                                    <span>Observacion por riesgo de compromiso clinico</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="irrigacion_vesical" class="rounded">
                                    <span>Irrigacion vesical</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="procedimiento_invasivo_medico" class="rounded">
                                    <span>Procedimiento invasivo realizado por medico</span>
                                </label>
                            </div>
                            
                            <p class="text-xs text-gray-600 mb-2 mt-4">UTI - Complejidad Media (3 puntos c/u):</p>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="drogas_vasoactivas" class="rounded">
                                    <span>Drogas vasoactivas</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="monitorizacion_continua" class="rounded">
                                    <span>Monitorizacion continua</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_mascarilla_reservorio" class="rounded">
                                    <span>Oxigeno por mascarilla con reservorio</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="dialisis_aguda" class="rounded">
                                    <span>Dialisis aguda</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_cnaf" class="rounded">
                                    <span>Oxigeno por CNAF</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="bic_insulina" class="rounded">
                                    <span>BIC insulina</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_vmni" class="rounded">
                                    <span>VMNI (Ventilacion mecanica no invasiva)</span>
                                </label>
                            </div>
                            
                            <p class="text-xs text-gray-600 mb-2 mt-4">UCI - Complejidad Alta (5 puntos c/u):</p>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_vmi" class="rounded">
                                    <span>Ventilacion mecanica invasiva</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="procuramiento_organos_tejidos" class="rounded">
                                    <span>Procuramiento de organos y tejidos</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">
                            Notas adicionales
                        </label>
                        <textarea id="notas" name="notas" rows="2" 
                                  class="w-full border rounded px-3 py-2" 
                                  placeholder="Informacion adicional relevante..."></textarea>
                    </div>

                    <div id="seccion-derivacion" class="border-t pt-4 mt-4">
                        <label class="flex items-center space-x-2 mb-3">
                            <input type="checkbox" id="derivar-paciente" onchange="toggleDerivacion()" class="rounded">
                            <span class="text-sm font-semibold text-purple-600">Derivar a otro hospital</span>
                        </label>
                        <div id="campos-derivacion" class="hidden space-y-3 ml-6">
                            <div>
                                <label class="block text-sm font-medium mb-1">Hospital Destino *</label>
                                <select id="hospital_destino" name="hospital_destino" class="w-full border rounded px-3 py-2">
                                    <option value="">Seleccionar hospital...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Motivo de Derivacion *</label>
                                <textarea id="motivo_derivacion" name="motivo_derivacion" rows="2" 
                                          class="w-full border rounded px-3 py-2" 
                                          placeholder="Ej: Requiere UCI, no disponible en este hospital..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold">
                            <span id="submit-text">Registrar Paciente</span>
                        </button>
                        <button type="button" onclick="closeModal('modal-ingresar')" 
                                class="px-6 py-2 border rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let HOSPITAL_ID = 'PMONTT';
        const API_BASE = '';
        let SERVICIO_FILTRO = '';

        function cambiarHospital() {
            HOSPITAL_ID = document.getElementById('hospital-selector').value;
            console.log('Hospital cambiado a:', HOSPITAL_ID);
            
            const filtroServicioContainer = document.getElementById('filtro-servicio-container');
            if (HOSPITAL_ID === 'PMONTT') {
                filtroServicioContainer.style.display = 'flex';
            } else {
                filtroServicioContainer.style.display = 'none';
                SERVICIO_FILTRO = '';
                document.getElementById('servicio-selector').value = '';
            }
            
            cargarDatos();
        }
        
        function filtrarPorServicio() {
            SERVICIO_FILTRO = document.getElementById('servicio-selector').value;
            console.log('Servicio filtrado:', SERVICIO_FILTRO || 'Todos');
            cargarDatos();
        }
        
        function getHospitalNombre(hospitalId) {
            const hospitales = {
                'PMONTT': 'Hospital Puerto Montt',
                'CALBUCO': 'Hospital Calbuco',
                'LLANHUE': 'Hospital Llanquihue'
            };
            return hospitales[hospitalId] || hospitalId;
        }

        function mostrarError(error) {
            let errorMsg = 'Error: ';
            if (typeof error === 'string') {
                errorMsg += error;
            } else if (error.detail) {
                if (typeof error.detail === 'string') {
                    errorMsg += error.detail;
                } else if (Array.isArray(error.detail)) {
                    errorMsg += error.detail.map(e => e.msg || JSON.stringify(e)).join(', ');
                } else {
                    errorMsg += JSON.stringify(error.detail);
                }
            } else {
                errorMsg += JSON.stringify(error);
            }
            alert(errorMsg);
        }

        const HOSPITALES = [
            { id: 'PMONTT', nombre: 'Hospital Puerto Montt' },
            { id: 'CALBUCO', nombre: 'Hospital Calbuco' },
            { id: 'LLANHUE', nombre: 'Hospital Llanquihue' }
        ];

        function toggleDerivacion() {
            const checkbox = document.getElementById('derivar-paciente');
            const camposDiv = document.getElementById('campos-derivacion');
            
            if (checkbox.checked) {
                camposDiv.classList.remove('hidden');
                document.getElementById('hospital_destino').required = true;
                document.getElementById('motivo_derivacion').required = true;
            } else {
                camposDiv.classList.add('hidden');
                document.getElementById('hospital_destino').required = false;
                document.getElementById('motivo_derivacion').required = false;
            }
        }

        function toggleEmbarazada() {
            const sexoMujer = document.getElementById('sexo_mujer');
            const divEmbarazada = document.getElementById('div-embarazada');
            
            if (sexoMujer && sexoMujer.checked) {
                divEmbarazada.classList.remove('hidden');
            } else {
                divEmbarazada.classList.add('hidden');
                document.getElementById('es_embarazada').checked = false;
            }
        }

        function cargarHospitalesEnSelector() {
            const select = document.getElementById('hospital_destino');
            select.innerHTML = '<option value="">Seleccionar hospital...</option>';
            
            HOSPITALES.forEach(hospital => {
                if (hospital.id !== HOSPITAL_ID) {
                    const option = document.createElement('option');
                    option.value = hospital.id;
                    option.textContent = hospital.nombre;
                    select.appendChild(option);
                }
            });
        }

        async function cargarDatos() {
            console.log('Recargando datos del hospital', HOSPITAL_ID);
            try {
                await Promise.all([
                    cargarEstadisticas(),
                    cargarCamas(),
                    cargarPacientesEspera()
                ]);
                console.log('Datos recargados exitosamente');
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        async function cargarEstadisticas() {
    try {
        const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/estadisticas');
        if (!response.ok) throw new Error('Error cargando estadísticas');
        const stats = await response.json();
        
        const container = document.getElementById('estadisticas-rapidas');
        container.innerHTML = `
            <div class="bg-white p-4 rounded-lg shadow text-center">
                <p class="text-3xl font-bold text-blue-600">${stats.total_camas}</p>
                <p class="text-sm text-gray-600">Total Camas</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow text-center">
                <p class="text-3xl font-bold text-green-600">${stats.por_estado.ocupada || 0}</p>
                <p class="text-sm text-gray-600">Ocupadas</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow text-center">
                <p class="text-3xl font-bold text-gray-600">${stats.por_estado.libre || 0}</p>
                <p class="text-sm text-gray-600">Libres</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow text-center">
                <p class="text-3xl font-bold text-yellow-600">${stats.por_estado.pendiente_traslado || 0}</p>
                <p class="text-sm text-gray-600">Pendientes</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow text-center">
                <p class="text-3xl font-bold text-purple-600">${stats.pacientes_en_espera || 0}</p>
                <p class="text-sm text-gray-600">En Espera</p>
            </div>
        `;
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('estadisticas-rapidas').innerHTML = 
            '<div class="col-span-5 text-center text-red-600">Error cargando datos</div>';
    }
}

        async function cargarCamas() {
    try {
        const responseCamas = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/camas');
        if (!responseCamas.ok) throw new Error('Error cargando camas');
        let camas = await responseCamas.json();
        
        const responsePacientes = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes');
        if (!responsePacientes.ok) throw new Error('Error cargando pacientes');
        const pacientesDelHospital = await responsePacientes.json();
        
        const pacientesPorId = {};
        pacientesDelHospital.forEach(p => { pacientesPorId[p.id] = p; });
        
        let pacientesDerivadosDesdeAqui = [];
        const hospitales = ['PMONTT', 'CALBUCO', 'LLANHUE'];
        for (const hospitalId of hospitales) {
            if (hospitalId !== HOSPITAL_ID) {
                try {
                    const respPac = await fetch(API_BASE + '/hospitales/' + hospitalId + '/pacientes');
                    if (respPac.ok) {
                        const pacientes = await respPac.json();
                        pacientesDerivadosDesdeAqui.push(...pacientes.filter(p => p.hospital_origen_id === HOSPITAL_ID));
                    }
                } catch (e) {
                    console.log('Error cargando pacientes de', hospitalId);
                }
            }
        }
        
        camas.forEach(cama => {
            const pacienteDerivado = pacientesDerivadosDesdeAqui.find(p => p.cama_origen_id === cama.id);
            if (pacienteDerivado) cama.paciente_derivado = pacienteDerivado;
            
            if (cama.paciente_id && pacientesPorId[cama.paciente_id]) {
                const pacienteData = pacientesPorId[cama.paciente_id];
                const camaPacienteInfo = cama.paciente_info || {};
                
                cama.paciente_info = {
                    ...pacienteData,
                    requiere_cambio_cama: camaPacienteInfo.requiere_cambio_cama || pacienteData.requiere_cambio_cama || false,
                    requiere_busqueda_cama: camaPacienteInfo.requiere_busqueda_cama || pacienteData.requiere_busqueda_cama || false,
                    requiere_nueva_cama: camaPacienteInfo.requiere_nueva_cama || pacienteData.requiere_nueva_cama || false,
                    motivo_cambio_cama: camaPacienteInfo.motivo_cambio_cama || pacienteData.motivo_cambio_cama || null
                };
            }
        });
        
        if (SERVICIO_FILTRO) {
            camas = camas.filter(cama => cama.servicio === SERVICIO_FILTRO);
        }
        
        const porServicio = {};
        camas.forEach(cama => {
            if (!porServicio[cama.servicio]) porServicio[cama.servicio] = {};
            if (!porServicio[cama.servicio][cama.sala]) porServicio[cama.servicio][cama.sala] = [];
            porServicio[cama.servicio][cama.sala].push(cama);
        });
        
        const container = document.getElementById('servicios-container');
        if (Object.keys(porServicio).length === 0) {
            container.innerHTML = '<div class="bg-white p-6 rounded-lg shadow text-center text-gray-500">No hay camas disponibles</div>';
            return;
        }
        
        container.innerHTML = Object.entries(porServicio).map(([servicio, salas]) => {
            const servicioNombre = servicio.toUpperCase().replace(/_/g, ' ');
            
            const salasHtml = Object.entries(salas).map(([nombreSala, camasSala]) => {
                const infoSala = camasSala[0];
                const esSalaCompartida = infoSala.es_sala_compartida || false;
                const sexoSala = infoSala.sexo_sala;
                const pacientesEnSala = infoSala.pacientes_en_sala || 0;
                const capacidadSala = infoSala.capacidad_sala || 1;
                
                let sexoIcon = '';
                if (esSalaCompartida && sexoSala) {
                    sexoIcon = sexoSala === 'hombre' ? 
                        '<span class="text-blue-600 font-bold ml-2">♂ Hombre</span>' : 
                        '<span class="text-pink-600 font-bold ml-2">♀ Mujer</span>';
                }
                
                const salaHeader = esSalaCompartida ? `
                    <div class="col-span-full bg-gray-100 p-2 rounded-lg mb-2 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-gray-700">${nombreSala}</span>
                            ${sexoIcon || '<span class="text-xs text-gray-500">(sin asignar)</span>'}
                        </div>
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">${pacientesEnSala}/${capacidadSala} ocupadas</span>
                    </div>
                ` : '';
                
                return salaHeader + camasSala.map(cama => renderCama(cama)).join('');
            }).join('');
            
            return `
                <div class="bg-white rounded-lg shadow p-6 mb-4">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">${servicioNombre}</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        ${salasHtml}
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('servicios-container').innerHTML = 
            '<div class="bg-red-100 p-6 rounded-lg shadow text-center text-red-600">Error: ' + error.message + '</div>';
    }
}

    function renderCama(cama) {
    const colores = {
        'libre': 'bg-gray-200 text-gray-700',
        'ocupada': 'bg-green-500 text-white',
        'pendiente_traslado': 'bg-yellow-400 text-gray-900',
        'en_traslado': 'bg-orange-400 text-white',
        'alta_sugerida': 'bg-blue-400 text-white',
        'requiere_busqueda_cama': 'bg-purple-500 text-white'
    };

    const color = colores[cama.estado] || 'bg-gray-300';
    const tieneEspecial = cama.paciente_info && (cama.paciente_info.caso_sociosanitario || cama.paciente_info.espera_cardio);

    let contenidoCama = '';
    if (cama.estado !== 'libre' && cama.paciente_nombre) {
        contenidoCama = `
            <div class="flex items-center justify-between mb-1">
                <div class="font-bold text-sm">${cama.paciente_nombre}</div>
                ${tieneEspecial ? '<div class="w-3 h-3 bg-purple-600 rounded-full" title="Caso especial"></div>' : ''}
            </div>
            <div class="text-xs mb-2">Cama: ${cama.id}</div>
        `;
    } else {
        contenidoCama = `
            <div class="font-bold text-sm mb-1">${cama.id}</div>
            <div class="text-xs mb-2">${cama.sala}</div>
        `;
    }

    return `<div class="${color} rounded-lg p-3 shadow-md relative">${contenidoCama}${renderBotonesCama(cama)}</div>`;
}

        function renderBotonesCama(cama) {
    // Si no hay paciente, no mostrar botones
    if (cama.estado === 'libre') {
        return '';
    }

    const paciente = cama.paciente_info;
    if (!paciente) {
        return '';
    }
    
    const esCasoEspecial = paciente.caso_sociosanitario || paciente.espera_cardio;
    const requiereCambio = paciente.requiere_cambio_cama || false;
    
    let botones = '<div class="mt-2 space-y-1">';
    
    // Mostrar alerta si requiere cambio
    if ((cama.estado === 'ocupada' || cama.estado === 'requiere_busqueda_cama') && requiereCambio) {
        botones += `
            <div class="bg-yellow-100 border-2 border-yellow-500 rounded p-2 mb-2">
                <div class="flex items-center justify-center text-yellow-700 text-xs font-bold mb-1">
                    CAMBIO DE CAMA REQUERIDO
                </div>
                <button onclick="manejarCambioCama('${paciente.id}')" 
                        class="w-full text-xs bg-yellow-500 text-white px-2 py-2 rounded hover:bg-yellow-600 font-bold">
                    Asignar Nueva Cama
                </button>
            </div>
        `;
    }
    
    // NUEVO: Mostrar estado de derivacion aceptada
    if (cama.estado === 'en_traslado' && paciente.derivacion_pendiente === false && paciente.paciente_aceptado_destino === true) {
        botones += `
            <div class="bg-green-100 border-2 border-green-500 rounded p-2 mb-2">
                <div class="flex items-center justify-center text-green-700 text-xs font-bold mb-1">
                    PACIENTE ACEPTADO EN DESTINO
                </div>
                <button onclick="cancelarTrasladoDerivacion('${paciente.id}')" 
                        class="w-full text-xs bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600 mb-1 font-bold">
                    Cancelar Traslado
                </button>
                <button onclick="egresarPacienteDerivacion('${paciente.id}')" 
                        class="w-full text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 font-bold">
                    Egresar Paciente
                </button>
            </div>
        `;
    }
    
    // Botones normales
    if (cama.estado === 'ocupada' || cama.estado === 'requiere_busqueda_cama') {
        botones += `
            <button onclick="reevaluarPaciente('${paciente.id}')" 
                    class="w-full text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                Reevaluar
            </button>
        `;
        
        if (!esCasoEspecial && !requiereCambio) {
            botones += `
                <button onclick="sugerirAlta('${cama.id}')" 
                        class="w-full text-xs bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600">
                    Sugerir Alta
                </button>
            `;
        }
    }
    
    if (cama.estado === 'alta_sugerida') {
        botones += `
            <button onclick="confirmarAlta('${cama.id}')" 
                    class="w-full text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                Confirmar Alta
            </button>
            <button onclick="cancelarAlta('${cama.id}')" 
                    class="w-full text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">
                Cancelar
            </button>
        `;
    }
    
    if (cama.estado === 'pendiente_traslado') {
        botones += `
            <button onclick="aceptarTraslado('${cama.id}')" 
                    class="w-full text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                Aceptar Traslado
            </button>
            <button onclick="rechazarTraslado('${cama.id}')" 
                    class="w-full text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">
                Rechazar
            </button>
        `;
    }
    
    if (cama.estado === 'en_traslado') {
        botones += `
            <div class="text-xs text-center text-orange-700 font-semibold">
                Esperando confirmacion
            </div>
        `;
    }
    
    botones += '</div>';
    return botones;
}

        async function cargarPacientesEspera() {
            try {
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes');
                if (!response.ok) {
                    console.error('Error cargando pacientes:', response.status);
                    return;
                }
                
                const pacientes = await response.json();
                console.log('Pacientes cargados:', pacientes.length);
                
                const enEspera = pacientes.filter(p => {
                    return p.en_espera && (p.cama_id === null || p.derivacion_pendiente);
                });
                
                console.log('Pacientes en espera:', enEspera.length);
                console.log('Pacientes derivados pendientes:', enEspera.filter(p => p.derivacion_pendiente).length);
                
                const container = document.getElementById('pacientes-espera-container');
                if (enEspera.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay pacientes en espera</p>';
                    return;
                }
                
                container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">' + enEspera.map(p => 
                    '<div class="border rounded p-3 ' + (p.derivacion_pendiente ? 'bg-purple-50 border-purple-300 border-2' : 'bg-white') + '">' +
                        '<div class="flex justify-between items-start mb-2">' +
                            '<div>' +
                                '<p class="font-semibold">' + p.nombre + '</p>' +
                                (p.derivacion_pendiente ? '<span class="text-xs bg-purple-600 text-white px-2 py-1 rounded inline-block mt-1">Derivado desde ' + (p.hospital_origen_id || 'otro hospital') + '</span>' : '') +
                            '</div>' +
                        '</div>' +
                        '<p class="text-sm text-gray-600">Sexo: ' + p.sexo + ' - Edad: ' + p.edad_categoria + '</p>' +
                        '<p class="text-sm text-gray-600">Espera: ' + p.tiempo_espera_min + ' min</p>' +
                        (p.es_embarazada ? '<span class="text-xs bg-pink-200 px-2 py-1 rounded mr-1">Embarazada</span>' : '') +
                        (p.es_adulto_mayor ? '<span class="text-xs bg-yellow-200 px-2 py-1 rounded">Adulto Mayor</span>' : '') +
                        (p.derivacion_pendiente ? 
                            '<div class="mt-3 p-2 bg-purple-100 rounded">' +
                                '<p class="text-xs text-purple-700 font-medium mb-2">' +
                                    '<strong>Motivo derivacion:</strong><br>' +
                                    (p.motivo_derivacion || 'No especificado') +
                                '</p>' +
                                '<div class="flex gap-2 mt-2">' +
                                    '<button onclick="verDetallesPaciente(\'' + p.id + '\')" class="flex-1 bg-blue-500 text-white px-2 py-2 rounded text-xs hover:bg-blue-600 font-semibold">Ver Detalles</button>' +
                                    '<button onclick="aceptarDerivacion(\'' + p.id + '\')" class="flex-1 bg-green-600 text-white px-2 py-2 rounded text-xs hover:bg-green-700 font-semibold">Aceptar</button>' +
                                    '<button onclick="rechazarDerivacion(\'' + p.id + '\')" class="flex-1 bg-red-600 text-white px-2 py-2 rounded text-xs hover:bg-red-700 font-semibold">Rechazar</button>' +
                                '</div>' +
                            '</div>' 
                        : '') +
                    '</div>'
                ).join('') + '</div>';
            } catch (error) {
                console.error('Error cargando pacientes en espera:', error);
            }
        }

        async function aceptarDerivacion(pacienteId) {
            if (!confirm('Aceptar este paciente derivado? Se buscara cama automaticamente.')) return;
            
            try {
                console.log('Aceptando derivacion de paciente', pacienteId, 'en hospital', HOSPITAL_ID);
                
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes/' + pacienteId + '/aceptar-derivacion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Respuesta del servidor:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Resultado:', result);
                    alert('Exito: ' + result.mensaje);
                    await cargarDatos();
                } else {
                    const error = await response.json();
                    console.error('Error del servidor:', error);
                    mostrarError(error);
                }
            } catch (error) {
                console.error('Error de red:', error);
                alert('Error de conexion: ' + error.message);
            }
        }

        async function rechazarDerivacion(pacienteId) {
            const motivoRechazo = prompt('Por que se rechaza esta derivacion?\n\nIngrese el motivo del rechazo:');
            
            if (!motivoRechazo || motivoRechazo.trim() === '') {
                alert('Debe ingresar un motivo para rechazar la derivacion');
                return;
            }
            
            if (!confirm('Confirmar rechazo de derivacion?\n\nEl paciente volvera al hospital de origen y se mantendra en su cama original.')) return;
            
            try {
                console.log('Rechazando derivacion de paciente', pacienteId, 'en hospital', HOSPITAL_ID);
                console.log('Motivo:', motivoRechazo);
                
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes/' + pacienteId + '/rechazar-derivacion', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        motivo_rechazo: motivoRechazo 
                    })
                });
                
                console.log('Respuesta del servidor:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Resultado:', result);
                    alert('Exito: ' + result.mensaje);
                    await cargarDatos();
                } else {
                    const error = await response.json();
                    console.error('Error del servidor:', error);
                    mostrarError(error);
                }
            } catch (error) {
                console.error('Error de red:', error);
                alert('Error de conexion: ' + error.message);
            }
        }

        async function manejarCambioCama(pacienteId) {
            if (!confirm('¿Enviar paciente a la lista de espera para asignación automática de nueva cama?')) return;
            
            try {
                // ✅ CORRECCIÓN: Llamar al endpoint de agregar a lista de espera
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes/' + pacienteId + '/agregar-a-lista-espera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert('✅ ' + data.mensaje + '\n\nEl sistema buscará y asignará automáticamente la mejor cama disponible según prioridad.');
                    await cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }


        async function verDetallesPaciente(pacienteId) {
            try {
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes');
                const pacientes = await response.json();
                const paciente = pacientes.find(p => p.id === pacienteId);
                
                if (!paciente) {
                    alert('Paciente no encontrado');
                    return;
                }
                
                const requerimientosMap = {
                    'tratamiento_endovenoso': 'Tratamiento endovenoso',
                    'dolor_intenso': 'Dolor intenso (EVA mayor o igual 7)',
                    'oxigeno_naricera': 'Oxigeno naricera',
                    'oxigeno_mascarilla_multiventuri': 'Oxigeno mascarilla multiventuri',
                    'aspiracion_invasiva': 'Aspiracion invasiva',
                    'irrigacion_vesical': 'Irrigacion vesical',
                    'drogas_vasoactivas': 'Drogas vasoactivas',
                    'monitorizacion_continua': 'Monitorizacion continua',
                    'oxigeno_mascarilla_reservorio': 'Oxigeno mascarilla reservorio',
                    'oxigeno_cnaf': 'Oxigeno CNAF',
                    'oxigeno_vmni': 'Oxigeno VMNI',
                    'dialisis_aguda': 'Dialisis aguda',
                    'oxigeno_vmi': 'Oxigeno VMI',
                    'procuramiento_organos_tejidos': 'Procuramiento de organos y tejidos',
                    'bic_insulina': 'BIC insulina',
                    'control_examenes_sangre_2mas': 'Control examen sangre 2+',
                    'curaciones_alta_complejidad': 'Curaciones alta complejidad',
                    'kinesioterapia_respiratoria': 'Kinesioterapia respiratoria',
                    'curaciones_heridas': 'Curaciones de heridas',
                    'control_examenes_sangre_1vez': 'Control examen sangre 1 vez'
                };
                
                const requerimientosHTML = paciente.requerimientos.length > 0
                    ? paciente.requerimientos.map(r => '<li>' + (requerimientosMap[r] || r) + '</li>').join('')
                    : '<li class="text-gray-500">Sin requerimientos</li>';
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = 
                    '<div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">' +
                        '<h3 class="text-xl font-bold mb-4">Detalles del Paciente</h3>' +
                        '<div class="space-y-3">' +
                            '<div><strong>Nombre:</strong> ' + paciente.nombre + '</div>' +
                            '<div><strong>Sexo:</strong> ' + paciente.sexo + '</div>' +
                            '<div><strong>Edad:</strong> ' + paciente.edad_categoria + '</div>' +
                            '<div><strong>Enfermedad:</strong> ' + paciente.enfermedad + '</div>' +
                            (paciente.diagnostico ? '<div><strong>Diagnostico:</strong> ' + paciente.diagnostico + '</div>' : '') +
                            '<div><strong>Aislamiento:</strong> ' + paciente.aislamiento + '</div>' +
                            '<div><strong>Complejidad:</strong> ' + paciente.complejidad_requerida + ' (' + paciente.puntos_complejidad + ' puntos)</div>' +
                            (paciente.es_embarazada ? '<div class="text-pink-600"><strong>Paciente embarazada</strong></div>' : '') +
                            (paciente.es_adulto_mayor ? '<div class="text-yellow-600"><strong>Adulto mayor</strong></div>' : '') +
                            ((paciente.caso_sociosanitario || paciente.espera_cardio) ? 
                                '<div class="border-t pt-3 mt-3 bg-purple-100 p-3 rounded">' +
                                    '<div class="flex items-center gap-2 mb-2">' +
                                        '<div class="w-4 h-4 bg-purple-600 rounded-full"></div>' +
                                        '<strong class="text-purple-800">CASOS ESPECIALES</strong>' +
                                    '</div>' +
                                    '<div class="text-sm space-y-1">' +
                                        (paciente.caso_sociosanitario ? '<div class="text-purple-700">Caso Sociosanitario</div>' : '') +
                                        (paciente.espera_cardio ? '<div class="text-purple-700">En espera de Cardiocirugia</div>' : '') +
                                        '<p class="text-xs text-purple-600 mt-2 italic">Este paciente NO puede ser dado de alta automaticamente</p>' +
                                    '</div>' +
                                '</div>' 
                            : '') +
                            (paciente.notas ? 
                                '<div class="border-t pt-3 mt-3">' +
                                    '<strong>Notas:</strong>' +
                                    '<p class="text-sm mt-1 text-gray-600">' + paciente.notas + '</p>' +
                                '</div>' 
                            : '') +
                            (paciente.derivacion_pendiente || paciente.motivo_derivacion || paciente.hospital_origen_id ? 
                                '<div class="border-t pt-3 mt-3">' +
                                    '<strong class="text-purple-600">Derivacion:</strong>' +
                                    (paciente.hospital_origen_id ? '<p class="text-sm mt-1"><strong>Desde:</strong> ' + getHospitalNombre(paciente.hospital_origen_id) + '</p>' : '') +
                                    (paciente.motivo_derivacion ? '<p class="text-sm mt-1"><strong>Motivo:</strong> ' + paciente.motivo_derivacion + '</p>' : '') +
                                    (paciente.motivo_rechazo_derivacion ? '<p class="text-sm mt-1 text-red-600"><strong>Rechazado:</strong> ' + paciente.motivo_rechazo_derivacion + '</p>' : '') +
                                    (paciente.derivacion_pendiente ? '<p class="text-xs mt-2 text-gray-500 italic">Estado: Pendiente de aceptacion</p>' : '') +
                                '</div>' 
                            : '') +
                            '<div class="border-t pt-3 mt-3">' +
                                '<strong>Requerimientos Clinicos:</strong>' +
                                '<ul class="list-disc ml-5 mt-2 text-sm">' + requerimientosHTML + '</ul>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex gap-2 mt-6">' +
                            '<button onclick="this.closest(\'.fixed\').remove()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cerrar</button>' +
                        '</div>' +
                    '</div>';
                document.body.appendChild(modal);
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function reevaluarPaciente(pacienteId) {
            try {
                console.log('Abriendo formulario de reevaluacion para:', pacienteId);
                
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes/' + pacienteId);
                if (!response.ok) {
                    throw new Error('No se pudo cargar los datos del paciente');
                }
                
                const paciente = await response.json();
                console.log('Datos del paciente:', paciente);
                
                document.getElementById('modal-title').textContent = 'Reevaluar Paciente';
                document.getElementById('es-reevaluacion').value = 'true';
                document.getElementById('paciente-id').value = paciente.id;
                
                document.getElementById('nombre').value = paciente.nombre;
                document.getElementById('nombre').disabled = true;
                
                document.getElementById('run').value = paciente.run;
                document.getElementById('run').disabled = true;
                
                if (paciente.sexo === 'hombre') {
                    document.getElementById('sexo_hombre').checked = true;
                } else {
                    document.getElementById('sexo_mujer').checked = true;
                }
                document.getElementById('sexo_hombre').disabled = true;
                document.getElementById('sexo_mujer').disabled = true;
                
                document.getElementById('edad').value = paciente.edad;
                document.getElementById('edad').disabled = true;
                
                if (document.getElementById('es_embarazada')) {
                    document.getElementById('es_embarazada').checked = paciente.es_embarazada || false;
                }
                
                if (document.getElementById('diagnostico')) {
                    document.getElementById('diagnostico').value = paciente.diagnostico || '';
                }
                
                document.getElementById('enfermedad').value = paciente.enfermedad;
                document.getElementById('aislamiento').value = paciente.aislamiento;
                
                if (document.getElementById('caso_sociosanitario')) {
                    document.getElementById('caso_sociosanitario').checked = paciente.caso_sociosanitario || false;
                }
                if (document.getElementById('espera_cardio')) {
                    document.getElementById('espera_cardio').checked = paciente.espera_cardio || false;
                }
                
                document.querySelectorAll('input[name="requerimientos"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                if (paciente.requerimientos && Array.isArray(paciente.requerimientos)) {
                    paciente.requerimientos.forEach(req => {
                        const checkbox = document.querySelector('input[name="requerimientos"][value="' + req + '"]');
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
                
                if (document.getElementById('notas')) {
                    document.getElementById('notas').value = paciente.notas || '';
                }
                
                const seccionDerivacion = document.getElementById('seccion-derivacion');
                if (seccionDerivacion) {
                    seccionDerivacion.style.display = 'block';
                }
                
                const derivacionCheckbox = document.getElementById('derivar-paciente');
                if (derivacionCheckbox) {
                    derivacionCheckbox.checked = false;
                    toggleDerivacion();
                }
                
                cargarHospitalesEnSelector();
                openModal('modal-ingresar');
                
            } catch (error) {
                console.error('Error al abrir formulario de reevaluacion:', error);
                alert('Error al cargar datos del paciente: ' + error.message);
            }
        }

        async function sugerirAlta(camaId) {
            if (!confirm('Sugerir alta para este paciente? La cama quedara marcada como candidata para alta.')) return;
            
            try {
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/camas/' + camaId + '/sugerir-alta', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Alta sugerida. La cama esta marcada para revision.');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // NUEVA FUNCIÓN: Cancelar traslado de derivacion
async function cancelarTrasladoDerivacion(pacienteId) {
    if (!confirm('Cancelar el traslado? El paciente volvera a su cama original en este hospital.')) return;
    
    try {
        const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/cancelar-traslado-derivacion`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(`OK: ${result.mensaje}`);
            cargarDatos();
        } else {
            const error = await response.json();
            mostrarError(error);
        }
    } catch (error) {
        alert('ERROR: ' + error.message);
    }
}

// NUEVA FUNCIÓN: Egresar paciente en derivacion
async function egresarPacienteDerivacion(pacienteId) {
    if (!confirm('Egresar al paciente? Esto liberara su cama actual. El paciente continuara su traslado al otro hospital.')) return;
    
    try {
        const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/egresar-paciente-derivacion`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(`OK: ${result.mensaje}`);
            cargarDatos();
        } else {
            const error = await response.json();
            mostrarError(error);
        }
    } catch (error) {
        alert('ERROR: ' + error.message);
    }
}

        async function confirmarAlta(camaId) {
            if (!confirm('Confirmar el alta del paciente?')) return;
            
            try {
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/camas/' + camaId + '/alta', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Alta confirmada');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function cancelarAlta(camaId) {
            if (!confirm('Cancelar o revertir el alta sugerida?')) return;
            
            try {
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/camas/' + camaId + '/cancelar-alta', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.mensaje);
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function aceptarTraslado(camaId) {
            if (!confirm('Confirmar que el paciente llego a esta cama?')) return;
            
            try {
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/camas/' + camaId + '/completar-traslado', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Traslado completado exitosamente');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function rechazarTraslado(camaId) {
            if (!confirm('Rechazar este traslado? La cama quedara libre y el paciente volvera a su cama anterior.')) return;
            
            try {
                const camasResponse = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/camas');
                const camas = await camasResponse.json();
                const cama = camas.find(c => c.id === camaId);
                
                if (!cama || !cama.paciente_id) {
                    alert('No se encontro el paciente en esta cama');
                    return;
                }
                
                const response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes/' + cama.paciente_id + '/cancelar-traslado', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Traslado rechazado. El paciente vuelve a su cama anterior.');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function sincronizarCola() {
            console.log('Sincronizando cola de espera...');
            await cargarDatos();
            alert('Cola sincronizada');
        }

        async function submitPacienteForm(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const esReevaluacion = formData.get('es_reevaluacion') === 'true';
            const pacienteId = formData.get('paciente_id');
            const derivarChecked = document.getElementById('derivar-paciente').checked;
            
            const requerimientos = [];
            formData.getAll('requerimientos').forEach(req => requerimientos.push(req));
            
            try {
                let response;
                
                if (esReevaluacion) {
                    response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes/' + pacienteId + '/reevaluar', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            enfermedad: formData.get('enfermedad'),
                            aislamiento: formData.get('aislamiento'),
                            caso_sociosanitario: formData.get('caso_sociosanitario') === 'on',
                            espera_cardio: formData.get('espera_cardio') === 'on',
                            requerimientos: requerimientos,
                            diagnostico: formData.get('diagnostico') || null,
                            notas: formData.get('notas') || null
                        })
                    });
                } else {
                    const data = {
                        nombre: formData.get('nombre'),
                        run: formData.get('run'),
                        sexo: formData.get('sexo'),
                        edad: parseInt(formData.get('edad')),
                        enfermedad: formData.get('enfermedad'),
                        aislamiento: formData.get('aislamiento'),
                        es_embarazada: formData.get('es_embarazada') === 'on',
                        caso_sociosanitario: formData.get('caso_sociosanitario') === 'on',
                        espera_cardio: formData.get('espera_cardio') === 'on',
                        requerimientos: requerimientos,
                        diagnostico: formData.get('diagnostico') || null,
                        notas: formData.get('notas') || null
                    };
                    
                    response = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes/ingresar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    const nuevoPacienteId = result.paciente ? result.paciente.id : pacienteId;
                    
                    if (derivarChecked && nuevoPacienteId) {
                        const hospitalDestino = formData.get('hospital_destino');
                        const motivoDerivacion = formData.get('motivo_derivacion');
                        
                        if (!hospitalDestino || !motivoDerivacion) {
                            alert('Debe completar los campos de derivacion');
                            return;
                        }
                        
                        const derivResponse = await fetch(API_BASE + '/hospitales/' + HOSPITAL_ID + '/pacientes/' + nuevoPacienteId + '/derivar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                hospital_destino_id: hospitalDestino,
                                motivo_derivacion: motivoDerivacion
                            })
                        });
                        
                        if (derivResponse.ok) {
                            const derivResult = await derivResponse.json();
                            alert('Paciente derivado a ' + derivResult.hospital_destino);
                        } else {
                            const errorDeriv = await derivResponse.json();
                            mostrarError(errorDeriv);
                            return;
                        }
                    } else {
                        let mensaje = esReevaluacion ? 'Paciente reevaluado' : 'Paciente registrado';
                        if (result.requiere_cambio_cama) {
                            mensaje += '\nRequiere cambio de cama - Presione Asignar Nueva Cama';
                        } else if (result.prioridad) {
                            mensaje += '\nPrioridad: ' + result.prioridad.toFixed(1);
                        }
                        alert(mensaje);
                    }
                    
                    closeModal('modal-ingresar');
                    form.reset();
                    document.getElementById('derivar-paciente').checked = false;
                    toggleDerivacion();
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function limpiarFormularioPaciente() {
            document.getElementById('form-paciente').reset();
            document.getElementById('modal-title').textContent = 'Registrar Nuevo Paciente';
            document.getElementById('submit-text').textContent = 'Registrar Paciente';
            document.getElementById('paciente-id').value = '';
            document.getElementById('es-reevaluacion').value = 'false';
            document.getElementById('nombre').disabled = false;
            document.getElementById('run').disabled = false;
            document.getElementById('edad').disabled = false;
            document.getElementById('sexo_hombre').disabled = false;
            document.getElementById('sexo_mujer').disabled = false;
            
            document.querySelectorAll('input[name="requerimientos"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            document.getElementById('derivar-paciente').checked = false;
            toggleDerivacion();
            
            const seccionDerivacion = document.getElementById('seccion-derivacion');
            if (seccionDerivacion) {
                seccionDerivacion.style.display = 'block';
            }
        }

        function abrirFormularioNuevoPaciente() {
            limpiarFormularioPaciente();
            cargarHospitalesEnSelector();
            toggleEmbarazada();
            openModal('modal-ingresar');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const sexoRadios = document.querySelectorAll('input[name="sexo"]');
            sexoRadios.forEach(radio => {
                radio.addEventListener('change', toggleEmbarazada);
            });
        });

        cargarDatos();
        setInterval(cargarDatos, 5000);
    </script>
</body>
</html>