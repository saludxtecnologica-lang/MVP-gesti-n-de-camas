<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital - Sistema de Gesti√≥n de Camas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">üè• Sistema de Gesti√≥n de Camas</h1>
                    <div class="flex items-center gap-4 mt-2">
                        <label class="text-blue-100 text-sm">Hospital:</label>
                        <select id="hospital-selector" onchange="cambiarHospital()" 
                                class="bg-white text-blue-900 px-4 py-2 rounded-lg font-semibold shadow">
                            <option value="PMONTT">Hospital Puerto Montt</option>
                            <option value="CALBUCO">Hospital Calbuco</option>
                            <option value="LLANHUE">Hospital Llanquihue</option>
                        </select>
                        
                        <div id="filtro-servicio-container" class="flex items-center gap-2">
                            <label class="text-blue-100 text-sm">Filtrar por servicio:</label>
                            <select id="servicio-selector" onchange="filtrarPorServicio()" 
                                    class="bg-white text-blue-900 px-4 py-2 rounded-lg font-semibold shadow">
                                <option value="">Todos los servicios</option>
                                <option value="uci">UCI</option>
                                <option value="uti">UTI</option>
                                <option value="medicina">Medicina</option>
                                <option value="cirugia">Cirug√≠a</option>
                                <option value="gineco">Ginecolog√≠a</option>
                                <option value="aislamiento">Aislamiento</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button onclick="abrirFormularioNuevoPaciente()" 
                        class="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 shadow-lg flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Registrar Paciente
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div id="estadisticas-rapidas" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            </div>

        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex justify-between items-center">
                <h3 class="font-semibold text-gray-700">Leyenda de Estados:</h3>
                <div class="flex gap-4 text-sm">
                    <span class="flex items-center"><span class="w-4 h-4 bg-gray-200 rounded mr-2"></span> Libre</span>
                    <span class="flex items-center"><span class="w-4 h-4 bg-green-500 rounded mr-2"></span> Ocupada</span>
                    <span class="flex items-center"><span class="w-4 h-4 bg-yellow-400 rounded mr-2"></span> Pendiente Traslado</span>
                    <span class="flex items-center"><span class="w-4 h-4 bg-orange-400 rounded mr-2"></span> En Traslado</span>
                    <span class="flex items-center"><span class="w-4 h-4 bg-blue-400 rounded mr-2"></span> Alta Sugerida</span>
                    <span class="flex items-center"><span class="w-3 h-3 bg-purple-600 rounded-full mr-2"></span> Caso Especial (no puede dar alta)</span>
                </div>
            </div>
        </div>

        <div id="servicios-container" class="space-y-6">
            </div>

        <div class="bg-white rounded-lg shadow p-6 mt-8">
            <h2 class="text-xl font-semibold mb-4">üë• Pacientes en Espera</h2>
            <div id="pacientes-espera-container">
                </div>
            <button onclick="asignarCamasAutomaticamente()" 
                    class="mt-4 w-full bg-green-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-green-700">
                üõèÔ∏è Asignar Camas Autom√°ticamente
            </button>
        </div>
    </div>

    <div id="modal-ingresar" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-title" class="text-2xl font-bold">Registrar Nuevo Paciente</h2>
                    <button onclick="closeModal('modal-ingresar')" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form onsubmit="submitPacienteForm(event)" id="form-paciente" class="space-y-4">
                    <input type="hidden" id="paciente-id" name="paciente_id" value="">
                    <input type="hidden" id="es-reevaluacion" name="es_reevaluacion" value="false">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nombre Completo *</label>
                            <input type="text" id="nombre" name="nombre" required class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">RUN *</label>
                            <input type="text" id="run" name="run" required placeholder="12345678-9" 
                                   pattern="[0-9]{7,8}-[0-9Kk]" 
                                   title="Formato: 12345678-9"
                                   class="w-full border rounded px-3 py-2">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Sexo *</label>
                        <div class="flex gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" id="sexo_hombre" name="sexo" value="hombre" required class="rounded">
                                <span class="text-sm font-medium">Hombre</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" id="sexo_mujer" name="sexo" value="mujer" required class="rounded">
                                <span class="text-sm font-medium">Mujer</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Edad (a√±os) *</label>
                        <input type="number" id="edad" name="edad" required min="0" max="120" 
                               class="w-full border rounded px-3 py-2"
                               placeholder="Ej: 45">
                        <p class="text-xs text-gray-500 mt-1">El sistema determina autom√°ticamente el rango etario</p>
                    </div>

                    <div id="div-embarazada" class="hidden">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="es_embarazada" name="es_embarazada" class="rounded">
                            <span class="text-sm font-medium">¬øPaciente embarazada?</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Diagn√≥stico</label>
                        <textarea id="diagnostico" name="diagnostico" rows="2" 
                                  class="w-full border rounded px-3 py-2" 
                                  placeholder="Ingrese el diagn√≥stico del paciente..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Tipo de Enfermedad *</label>
                        <select id="enfermedad" name="enfermedad" required class="w-full border rounded px-3 py-2">
                            <option value="">Seleccionar...</option>
                            <option value="medica">M√©dica</option>
                            <option value="quirurgica">Quir√∫rgica</option>
                            <option value="traumatologica">Traumatol√≥gica</option>
                            <option value="neurologica">Neurol√≥gica</option>
                            <option value="geriatrica">Geri√°trica</option>
                            <option value="urologica">Urol√≥gica</option>
                            <option value="ginecologica">Ginecol√≥gica</option>
                            <option value="obstetrica">Obst√©trica</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Tipo de Aislamiento</label>
                        <select id="aislamiento" name="aislamiento" class="w-full border rounded px-3 py-2">
                            <option value="ninguno">Ninguno</option>
                            <option value="contacto">Contacto (puede compartir sala)</option>
                            <option value="gotitas">Gotitas (puede compartir sala)</option>
                            <option value="aereo">A√©reo (cama individual)</option>
                            <option value="ambiente_protegido">Ambiente protegido (cama individual)</option>
                            <option value="aislamiento_especial" title="C. difficile, KPC, otros">Aislamiento especial (cama individual) ‚Ñπ</option>
                        </select>
                    </div>

                    <div class="border rounded p-4 bg-purple-50">
                        <label class="block text-sm font-medium mb-2 text-purple-800">Casos Especiales (Bloquean Alta Autom√°tica)</label>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="caso_sociosanitario" name="caso_sociosanitario" class="rounded">
                                <span class="text-sm font-medium">Caso Sociosanitario</span>
                                <span class="text-xs text-gray-600 ml-2">(Paciente que requiere apoyo social antes del alta)</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="espera_cardio" name="espera_cardio" class="rounded">
                                <span class="text-sm font-medium">En espera de Cardiocirug√≠a</span>
                                <span class="text-xs text-gray-600 ml-2">(Paciente esperando procedimiento cardioquir√∫rgico)</span>
                            </label>
                        </div>
                        <p class="text-xs text-purple-700 mt-2">
                            ‚ö†Ô∏è Los pacientes con casos especiales NO pueden ser dados de alta autom√°ticamente, 
                            incluso si no tienen requerimientos cl√≠nicos.
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Requerimientos Cl√≠nicos</label>
                        <div class="border rounded p-4 space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-xs text-gray-600 mb-2 font-semibold">
                                Requerimientos que NO definen cama ni necesidad de hospitalizaci√≥n:
                                <span class="cursor-help ml-1 text-blue-600" title="Prestaciones por Hodom, Hosdom o CESFAM">‚Ñπ</span>
                            </p>
                            <div class="grid grid-cols-2 gap-2 bg-gray-50 p-2 rounded mb-4">
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="kinesioterapia_respiratoria" class="rounded">
                                    <span>Kinesioterapia respiratoria</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="curaciones_heridas" class="rounded">
                                    <span>Curaciones de heridas</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="control_examenes_sangre_1vez" class="rounded">
                                    <span>Control con examen de sangre (1 vez)</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="tratamiento_endovenoso_2menos" class="rounded">
                                    <span>Tratamiento endovenoso por 2 veces o menos</span>
                                </label>
                            </div>
                            
                            <p class="text-xs text-gray-600 mb-2 mt-4">Baja Complejidad (1 punto c/u):</p>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="tratamiento_endovenoso" class="rounded">
                                    <span>Tratamiento endovenoso por 3 veces o m√°s
                                        <span class="cursor-help ml-1 text-blue-600" title="Independiente del tipo de medicamentos">‚Ñπ</span>
                                    </span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="control_examenes_sangre_2mas" class="rounded">
                                    <span>Control con examen de sangre 2 veces o m√°s</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_naricera" class="rounded">
                                    <span>Ox√≠geno por naricera</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="dolor_intenso" class="rounded">
                                    <span>Dolor intenso (EVA ‚â•7)</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_mascarilla_multiventuri" class="rounded">
                                    <span>Ox√≠geno por mascarilla multiventuri</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="curaciones_alta_complejidad" class="rounded">
                                    <span>Curaciones de alta complejidad
                                        <span class="cursor-help ml-1 text-blue-600" title="Incluye: VAC, gran quemados, etc.">‚Ñπ</span>
                                    </span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="aspiracion_invasiva" class="rounded">
                                    <span>Aspiraci√≥n invasiva de secreciones bronquiales</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="observacion_riesgo_compromiso" class="rounded">
                                    <span>Observaci√≥n por riesgo de compromiso cl√≠nico</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="irrigacion_vesical" class="rounded">
                                    <span>Irrigaci√≥n vesical</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="procedimiento_invasivo_medico" class="rounded">
                                    <span>Procedimiento invasivo realizado por m√©dico</span>
                                </label>
                            </div>
                            
                            <p class="text-xs text-gray-600 mb-2 mt-4">UTI - Complejidad Media (3 puntos c/u):</p>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="drogas_vasoactivas" class="rounded">
                                    <span>Drogas vasoactivas</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="monitorizacion_continua" class="rounded">
                                    <span>Monitorizaci√≥n continua
                                        <span class="cursor-help ml-1 text-blue-600" title="Controles de signos vitales cada 4 horas o menos">‚Ñπ</span>
                                    </span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_mascarilla_reservorio" class="rounded">
                                    <span>Ox√≠geno por mascarilla con reservorio</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="dialisis_aguda" class="rounded">
                                    <span>Di√°lisis aguda</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_cnaf" class="rounded">
                                    <span>Ox√≠geno por CNAF</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="bic_insulina" class="rounded">
                                    <span>BIC insulina</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_vmni" class="rounded">
                                    <span>VMNI (Ventilaci√≥n mec√°nica no invasiva)</span>
                                </label>
                            </div>
                            
                            <p class="text-xs text-gray-600 mb-2 mt-4">UCI - Complejidad Alta (5 puntos c/u):</p>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="oxigeno_vmi" class="rounded">
                                    <span>Ventilaci√≥n mec√°nica invasiva</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm">
                                    <input type="checkbox" name="requerimientos" value="procuramiento_organos_tejidos" class="rounded">
                                    <span>Procuramiento de √≥rganos y tejidos</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="campos-monitorizacion" class="hidden border border-blue-300 rounded p-4 space-y-3 bg-blue-50">
                        <p class="text-sm font-semibold text-blue-800">Detalles de Monitorizaci√≥n/Observaci√≥n:</p>
                        <div>
                            <label class="block text-sm font-medium mb-1">Motivo de monitorizaci√≥n/observaci√≥n *</label>
                            <textarea id="motivo_monitorizacion" name="motivo_monitorizacion" rows="2" 
                                      class="w-full border rounded px-3 py-2" 
                                      placeholder="Describa el motivo de la monitorizaci√≥n continua u observaci√≥n..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Signos, s√≠ntomas o ex√°menes que respalden *</label>
                            <textarea id="signos_monitorizacion" name="signos_monitorizacion" rows="2" 
                                      class="w-full border rounded px-3 py-2" 
                                      placeholder="Describa los signos vitales, s√≠ntomas o ex√°menes relevantes..."></textarea>
                        </div>
                    </div>

                    <div id="campos-procedimiento-invasivo" class="hidden border border-purple-300 rounded p-4 space-y-3 bg-purple-50">
                        <p class="text-sm font-semibold text-purple-800">Detalle del Procedimiento Invasivo:</p>
                        <div>
                            <label class="block text-sm font-medium mb-1">Especifique el procedimiento *</label>
                            <textarea id="detalle_procedimiento_invasivo" name="detalle_procedimiento_invasivo" rows="2" 
                                      class="w-full border rounded px-3 py-2" 
                                      placeholder="Describa el procedimiento invasivo realizado por m√©dico..."></textarea>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">
                            Notas adicionales
                            <span class="text-xs text-gray-500 ml-1" title="Informaci√≥n adicional relevante sobre el paciente">‚Ñπ</span>
                        </label>
                        <textarea id="notas" name="notas" rows="2" 
                                  class="w-full border rounded px-3 py-2" 
                                  placeholder="Informaci√≥n adicional relevante..."></textarea>
                    </div>

                    <div id="seccion-derivacion" class="border-t pt-4 mt-4">
                        <label class="flex items-center space-x-2 mb-3">
                            <input type="checkbox" id="derivar-paciente" onchange="toggleDerivacion()" class="rounded">
                            <span class="text-sm font-semibold text-purple-600">üè• Derivar a otro hospital</span>
                        </label>
                        <div id="campos-derivacion" class="hidden space-y-3 ml-6">
                            <div>
                                <label class="block text-sm font-medium mb-1">Hospital Destino *</label>
                                <select id="hospital_destino" name="hospital_destino" class="w-full border rounded px-3 py-2">
                                    <option value="">Seleccionar hospital...</option>
                                    </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Motivo de Derivaci√≥n *</label>
                                <textarea id="motivo_derivacion" name="motivo_derivacion" rows="2" 
                                          class="w-full border rounded px-3 py-2" 
                                          placeholder="Ej: Requiere UCI, no disponible en este hospital..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold">
                            <span id="submit-text">Registrar Paciente</span>
                        </button>
                        <button type="button" onclick="closeModal('modal-ingresar')" 
                                class="px-6 py-2 border rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        
        let HOSPITAL_ID = 'PMONTT';  // Hospital por defecto
        const API_BASE = '';
        let SERVICIO_FILTRO = '';  // Filtro de servicio actual

        function cambiarHospital() {
            HOSPITAL_ID = document.getElementById('hospital-selector').value;
            console.log('Hospital cambiado a:', HOSPITAL_ID);
            
            // Mostrar/ocultar filtro de servicio solo para Puerto Montt
            const filtroServicioContainer = document.getElementById('filtro-servicio-container');
            if (HOSPITAL_ID === 'PMONTT') {
                filtroServicioContainer.style.display = 'flex';
            } else {
                filtroServicioContainer.style.display = 'none';
                SERVICIO_FILTRO = ''; // Resetear filtro
                document.getElementById('servicio-selector').value = '';
            }
            
            cargarDatos();  // Recargar datos del nuevo hospital
        }
        
        function filtrarPorServicio() {
            SERVICIO_FILTRO = document.getElementById('servicio-selector').value;
            console.log('Servicio filtrado:', SERVICIO_FILTRO || 'Todos');
            cargarDatos();  // Recargar datos con el filtro
        }
        
        function getHospitalNombre(hospitalId) {
            const hospitales = {
                'PMONTT': 'Hospital Puerto Montt',
                'CALBUCO': 'Hospital Calbuco',
                'LLANHUE': 'Hospital Llanquihue'
            };
            return hospitales[hospitalId] || hospitalId;
        }

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================

        function mostrarError(error) {
            let errorMsg = '‚ùå Error: ';
            if (typeof error === 'string') {
                errorMsg += error;
            } else if (error.detail) {
                if (typeof error.detail === 'string') {
                    errorMsg += error.detail;
                } else if (Array.isArray(error.detail)) {
                    errorMsg += error.detail.map(e => e.msg || JSON.stringify(e)).join(', ');
                } else {
                    errorMsg += JSON.stringify(error.detail);
                }
            } else {
                errorMsg += JSON.stringify(error);
            }
            alert(errorMsg);
        }

        const HOSPITALES = [
            { id: 'PMONTT', nombre: 'Hospital Puerto Montt' },
            { id: 'CALBUCO', nombre: 'Hospital Calbuco' },
            { id: 'LLANHUE', nombre: 'Hospital Llanquihue' }
        ];

        function toggleDerivacion() {
            const checkbox = document.getElementById('derivar-paciente');
            const camposDiv = document.getElementById('campos-derivacion');
            
            if (checkbox.checked) {
                camposDiv.classList.remove('hidden');
                // Marcar campos como requeridos
                document.getElementById('hospital_destino').required = true;
                document.getElementById('motivo_derivacion').required = true;
            } else {
                camposDiv.classList.add('hidden');
                document.getElementById('hospital_destino').required = false;
                document.getElementById('motivo_derivacion').required = false;
            }
        }

        function toggleEmbarazada() {
            // Mostrar checkbox de embarazada solo si el sexo es mujer
            const sexoMujer = document.getElementById('sexo_mujer');
            const divEmbarazada = document.getElementById('div-embarazada');
            
            if (sexoMujer && sexoMujer.checked) {
                divEmbarazada.classList.remove('hidden');
            } else {
                divEmbarazada.classList.add('hidden');
                // Desmarcar el checkbox si se oculta
                document.getElementById('es_embarazada').checked = false;
            }
        }

        function toggleCamposProcedimientoInvasivo() {
            // Mostrar campo de detalle si se selecciona procedimiento_invasivo_medico
            const procedimientoCheckbox = document.querySelector('input[value="procedimiento_invasivo_medico"]');
            const camposDiv = document.getElementById('campos-procedimiento-invasivo');
            
            if (procedimientoCheckbox && procedimientoCheckbox.checked) {
                camposDiv.classList.remove('hidden');
                document.getElementById('detalle_procedimiento_invasivo').required = true;
            } else {
                camposDiv.classList.add('hidden');
                document.getElementById('detalle_procedimiento_invasivo').required = false;
            }
        }

        function toggleCamposMonitorizacion() {
            // Obtener todos los checkboxes de requerimientos seleccionados
            const checkboxes = document.querySelectorAll('input[name="requerimientos"]:checked');
            const monitorizacionCheckbox = document.querySelector('input[value="monitorizacion_continua"]');
            const observacionCheckbox = document.querySelector('input[value="observacion_riesgo_compromiso"]');
            const camposDiv = document.getElementById('campos-monitorizacion');
            
            // Definir requerimientos UTI (3 puntos)
            const requerimientosUTI = [
                'drogas_vasoactivas',
                'monitorizacion_continua',
                'oxigeno_mascarilla_reservorio',
                'oxigeno_cnaf',
                'oxigeno_vmni',
                'dialisis_aguda',
                'bic_insulina'
            ];
            
            // Definir requerimientos de baja complejidad
            const requerimientosBaja = [
                'tratamiento_endovenoso',
                'dolor_intenso',
                'oxigeno_naricera',
                'oxigeno_mascarilla_multiventuri',
                'aspiracion_invasiva',
                'control_examenes_sangre_2mas',
                'curaciones_alta_complejidad',
                'irrigacion_vesical',
                'observacion_riesgo_compromiso'
            ];
            
            // Verificar si monitorizacion_continua u observacion_riesgo_compromiso est√°n seleccionadas
            const monCheckboxChecked = monitorizacionCheckbox && monitorizacionCheckbox.checked;
            const obsCheckboxChecked = observacionCheckbox && observacionCheckbox.checked;
            
            if (!monCheckboxChecked && !obsCheckboxChecked) {
                camposDiv.classList.add('hidden');
                document.getElementById('motivo_monitorizacion').required = false;
                document.getElementById('signos_monitorizacion').required = false;
                return;
            }
            
            // Obtener los valores seleccionados
            const valoresSeleccionados = Array.from(checkboxes).map(cb => cb.value);
            
            // Filtrar solo requerimientos UTI seleccionados
            const requerimientosUTISeleccionados = valoresSeleccionados.filter(val => 
                requerimientosUTI.includes(val)
            );
            
            // Filtrar solo requerimientos de baja complejidad seleccionados
            const requerimientosBajaSeleccionados = valoresSeleccionados.filter(val => 
                requerimientosBaja.includes(val)
            );
            
            // Mostrar campos si:
            // 1. monitorizacion_continua es el √öNICO requerimiento UTI seleccionado, O
            // 2. observacion_riesgo_compromiso es el √öNICO requerimiento de baja seleccionado
            const soloMonitorizacion = requerimientosUTISeleccionados.length === 1 && 
                                      requerimientosUTISeleccionados[0] === 'monitorizacion_continua';
            const soloObservacion = requerimientosBajaSeleccionados.length === 1 && 
                                   requerimientosBajaSeleccionados[0] === 'observacion_riesgo_compromiso';
            
            if (soloMonitorizacion || soloObservacion) {
                camposDiv.classList.remove('hidden');
                document.getElementById('motivo_monitorizacion').required = true;
                document.getElementById('signos_monitorizacion').required = true;
            } else {
                camposDiv.classList.add('hidden');
                document.getElementById('motivo_monitorizacion').required = false;
                document.getElementById('signos_monitorizacion').required = false;
            }
        }

        function cargarHospitalesEnSelector() {
            const select = document.getElementById('hospital_destino');
            select.innerHTML = '<option value="">Seleccionar hospital...</option>';
            
            HOSPITALES.forEach(hospital => {
                if (hospital.id !== HOSPITAL_ID) {  // No incluir el hospital actual
                    const option = document.createElement('option');
                    option.value = hospital.id;
                    option.textContent = hospital.nombre;
                    select.appendChild(option);
                }
            });
        }

        // ============================================
        // CARGAR DATOS
        // ============================================

        async function cargarDatos() {
            try {
                await Promise.all([
                    cargarEstadisticas(),
                    cargarCamas(),
                    cargarPacientesEspera()
                ]);
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        async function cargarEstadisticas() {
            const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/estadisticas`);
            const stats = await response.json();
            
            const container = document.getElementById('estadisticas-rapidas');
            container.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow text-center">
                    <p class="text-3xl font-bold text-blue-600">${stats.total_camas}</p>
                    <p class="text-sm text-gray-600">Total Camas</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow text-center">
                    <p class="text-3xl font-bold text-green-600">${stats.por_estado.ocupada || 0}</p>
                    <p class="text-sm text-gray-600">Ocupadas</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow text-center">
                    <p class="text-3xl font-bold text-gray-600">${stats.por_estado.libre || 0}</p>
                    <p class="text-sm text-gray-600">Libres</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow text-center">
                    <p class="text-3xl font-bold text-yellow-600">${stats.por_estado.pendiente_traslado || 0}</p>
                    <p class="text-sm text-gray-600">Pendientes</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow text-center">
                    <p class="text-3xl font-bold text-purple-600">${stats.pacientes_en_espera}</p>
                    <p class="text-sm text-gray-600">En Espera</p>
                </div>
            `;
        }

        async function cargarCamas() {
            const responseCamas = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/camas`);
            let camas = await responseCamas.json();
            
            // Cargar todos los pacientes (necesitamos ver pacientes derivados desde este hospital)
            const responsePacientes = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes`);
            const pacientesDelHospital = await responsePacientes.json();
            
            // Crear mapa de pacientes por ID para agregar informaci√≥n adicional a las camas
            const pacientesPorId = {};
            pacientesDelHospital.forEach(p => {
                pacientesPorId[p.id] = p;
            });
            
            // Buscar pacientes derivados DESDE este hospital (hospital_origen_id === HOSPITAL_ID)
            // Para esto necesitamos buscar en todos los hospitales
            let pacientesDerivadosDesdeAqui = [];
            const hospitales = ['PMONTT', 'CALBUCO', 'LLANHUE'];
            for (const hospitalId of hospitales) {
                if (hospitalId !== HOSPITAL_ID) {
                    try {
                        const respPac = await fetch(`${API_BASE}/hospitales/${hospitalId}/pacientes`);
                        const pacientes = await respPac.json();
                        const derivadosDesdeEsteHospital = pacientes.filter(p => p.hospital_origen_id === HOSPITAL_ID);
                        pacientesDerivadosDesdeAqui.push(...derivadosDesdeEsteHospital);
                    } catch (e) {
                        console.log('Error cargando pacientes de', hospitalId, e);
                    }
                }
            }
            
            // Agregar informaci√≥n de pacientes derivados a las camas
            camas.forEach(cama => {
                const pacienteDerivado = pacientesDerivadosDesdeAqui.find(p => p.cama_origen_id === cama.id);
                if (pacienteDerivado) {
                    cama.paciente_derivado = pacienteDerivado;
                }
                // Agregar informaci√≥n completa del paciente si est√° ocupada
                if (cama.paciente_id && pacientesPorId[cama.paciente_id]) {
                    cama.paciente_info = pacientesPorId[cama.paciente_id];
                }
            });
            
            // Aplicar filtro de servicio si est√° activo
            if (SERVICIO_FILTRO) {
                camas = camas.filter(cama => cama.servicio === SERVICIO_FILTRO);
            }
            
            // Agrupar por servicio y luego por sala
            const porServicio = {};
            camas.forEach(cama => {
                if (!porServicio[cama.servicio]) {
                    porServicio[cama.servicio] = {};
                }
                if (!porServicio[cama.servicio][cama.sala]) {
                    porServicio[cama.servicio][cama.sala] = [];
                }
                porServicio[cama.servicio][cama.sala].push(cama);
            });
            
            // Renderizar
            const container = document.getElementById('servicios-container');
            container.innerHTML = Object.entries(porServicio).map(([servicio, salas]) => {
                const servicioNombre = servicio.toUpperCase().replace('_', ' ');
                
                // Renderizar salas
                const salasHtml = Object.entries(salas).map(([nombreSala, camasSala]) => {
                    // Obtener info de la sala
                    const infoSala = camasSala[0];
                    const esSalaCompartida = infoSala.es_sala_compartida || false;
                    const sexoSala = infoSala.sexo_sala;
                    const pacientesEnSala = infoSala.pacientes_en_sala || 0;
                    const capacidadSala = infoSala.capacidad_sala || 1;
                    
                    // Icono de sexo
                    let sexoIcon = '';
                    if (esSalaCompartida && sexoSala) {
                        sexoIcon = sexoSala === 'hombre' ? 
                            '<span class="text-blue-600 font-bold">‚ôÇ</span>' : 
                            '<span class="text-pink-600 font-bold">‚ôÄ</span>';
                    }
                    
                    // Header de sala
                    const salaHeader = esSalaCompartida ? `
                        <div class="col-span-full bg-gray-100 p-2 rounded-lg mb-2 flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-gray-700">${nombreSala}</span>
                                ${sexoIcon}
                                ${sexoSala ? `<span class="text-xs text-gray-600">(${sexoSala})</span>` : 
                                  '<span class="text-xs text-gray-500">(sin asignar)</span>'}
                            </div>
                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">
                                ${pacientesEnSala}/${capacidadSala} ocupadas
                            </span>
                        </div>
                    ` : '';
                    
                    return `
                        ${salaHeader}
                        ${camasSala.map(cama => renderCama(cama)).join('')}
                    `;
                }).join('');
                
                return `
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">${servicioNombre}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            ${salasHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCama(cama) {
            const colores = {
                'libre': 'bg-gray-200 text-gray-700',
                'ocupada': 'bg-green-500 text-white',
                'pendiente_traslado': 'bg-yellow-400 text-gray-900',
                'en_traslado': 'bg-orange-400 text-white',
                'alta_sugerida': 'bg-blue-400 text-white'
            };
            
            const color = colores[cama.estado] || 'bg-gray-300';
            
            // Verificar si el paciente tiene requerimientos especiales
            const tieneEspecial = cama.paciente_info && 
                                   (cama.paciente_info.caso_sociosanitario || 
                                    cama.paciente_info.espera_cardio);
            
            // Si hay paciente, mostrar nombre arriba y n√∫mero de cama abajo
            // Si no hay paciente, mostrar solo n√∫mero de cama
            let contenidoCama = '';
            if (cama.estado !== 'libre' && cama.paciente_nombre) {
                contenidoCama = `
                    <div class="flex items-center justify-between mb-1">
                        <div class="font-bold text-sm">${cama.paciente_nombre}</div>
                        ${tieneEspecial ? '<div class="w-3 h-3 bg-purple-600 rounded-full" title="Caso especial: No puede ser dado de alta"></div>' : ''}
                    </div>
                    <div class="text-xs mb-2">Cama: ${cama.id}</div>
                `;
            } else {
                contenidoCama = `
                    <div class="font-bold text-sm mb-1">${cama.id}</div>
                    <div class="text-xs mb-2">${cama.sala}</div>
                `;
            }
            
            return `
                <div class="${color} rounded-lg p-3 shadow-md relative">
                    ${contenidoCama}
                    ${renderBotonesCama(cama)}
                </div>
            `;
        }

        function renderBotonesCama(cama) {
            // Si no hay paciente, no mostrar botones
            if (cama.estado === 'libre') {
                return '';
            }
    
            const paciente = cama.paciente_info;
            if (!paciente) {
                return '';
            }
            
            const esCasoEspecial = paciente.caso_sociosanitario || paciente.espera_cardio;
            
            // ‚úÖ NUEVO: Verificar si requiere cambio de cama
            const requiereCambio = paciente.requiere_cambio_cama || false;
            
            let botones = '<div class="mt-2 space-y-1">';
            
            // ‚úÖ MODIFICADO: Mostrar alerta si requiere cambio con bot√≥n de asignaci√≥n autom√°tica
            if (cama.estado === 'ocupada' && requiereCambio) {
                botones += `
                    <div class="bg-yellow-100 border-2 border-yellow-500 rounded p-2 mb-2">
                        <div class="flex items-center justify-center text-yellow-700 text-xs font-bold mb-1">
                            ‚ö†Ô∏è CAMBIO DE CAMA REQUERIDO
                        </div>
                        <button onclick="manejarCambioCama('${paciente.id}')" 
                                class="w-full text-xs bg-yellow-500 text-white px-2 py-2 rounded hover:bg-yellow-600 font-bold">
                            üõèÔ∏è Asignar Nueva Cama
                        </button>
                    </div>
                `;
            }
            
            // Botones normales
            if (cama.estado === 'ocupada') {
                botones += `
                    <button onclick="reevaluarPaciente('${paciente.id}')" 
                            class="w-full text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                        üîÑ Reevaluar
                    </button>
                `;
                
                if (!esCasoEspecial && !requiereCambio) {
                    botones += `
                        <button onclick="sugerirAlta('${cama.id}')" 
                                class="w-full text-xs bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600">
                            üìã Sugerir Alta
                        </button>
                    `;
                }
            }
            
            if (cama.estado === 'alta_sugerida') {
                botones += `
                    <button onclick="confirmarAlta('${cama.id}')" 
                            class="w-full text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                        ‚úÖ Confirmar Alta
                    </button>
                    <button onclick="cancelarAlta('${cama.id}')" 
                            class="w-full text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">
                        ‚ùå Cancelar
                    </button>
                `;
            }
            
            if (cama.estado === 'pendiente_traslado') {
                botones += `
                    <button onclick="aceptarTraslado('${cama.id}')" 
                            class="w-full text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                        ‚úÖ Aceptar Traslado
                    </button>
                    <button onclick="rechazarTraslado('${cama.id}')" 
                            class="w-full text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">
                        ‚ùå Rechazar
                    </button>
                `;
            }
            
            if (cama.estado === 'en_traslado') {
            //: Siempre mostrar bot√≥n Cancelar Traslado
            botones += `
                <button onclick="cancelarTrasladoDesdeOrigen('${paciente.id}')" 
                        class="w-full text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 mb-1">
                    ‚ùå Cancelar Traslado
                </button>
            `;
            
            // Si es derivaci√≥n a otro hospital, mostrar Confirmar Egreso
            if (cama.paciente_derivado) {
                botones += `
                    <button onclick="confirmarEgreso('${paciente.id}')" 
                            class="w-full text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                        ‚úÖ Confirmar Egreso
                    </button>
                `;
            } else {
                botones += `
                    <div class="text-xs text-center text-orange-700 font-semibold">
                        ‚è≥ Esperando confirmaci√≥n
                    </div>
                `;
            }
        }
            
            botones += '</div>';
            return botones;
        }

        async function cargarPacientesEspera() {
            const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes`);
            const pacientes = await response.json();
            
            const enEspera = pacientes.filter(p => p.en_espera || p.derivacion_pendiente);
            
            const container = document.getElementById('pacientes-espera-container');
            if (enEspera.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay pacientes en espera</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    ${enEspera.map(p => `
                        <div class="border rounded p-3 ${p.derivacion_pendiente ? 'bg-purple-50 border-purple-300' : ''}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="font-semibold">${p.nombre}</p>
                                    ${p.derivacion_pendiente ? '<span class="text-xs bg-purple-600 text-white px-2 py-1 rounded">üè• Derivado</span>' : ''}
                                </div>
                            </div>
                            <p class="text-sm text-gray-600">Espera: ${p.tiempo_espera_min} min</p>
                            ${p.es_embarazada ? '<span class="text-xs bg-pink-200 px-2 py-1 rounded mr-1">Embarazada</span>' : ''}
                            ${p.es_adulto_mayor ? '<span class="text-xs bg-yellow-200 px-2 py-1 rounded">Adulto Mayor</span>' : ''}
                            
                            ${p.derivacion_pendiente ? `
                                <div class="mt-3 space-y-2">
                                    <p class="text-xs text-purple-700 font-medium">Motivo: ${p.motivo_derivacion || 'No especificado'}</p>
                                    <div class="flex gap-2">
                                        <button onclick="verDetallesPaciente('${p.id}')" 
                                                class="flex-1 bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                            üëÅÔ∏è Ver
                                        </button>
                                        <button onclick="aceptarDerivacion('${p.id}')" 
                                                class="flex-1 bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">
                                            ‚úî Aceptar
                                        </button>
                                        <button onclick="rechazarDerivacion('${p.id}')" 
                                                class="flex-1 bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                            ‚úó Rechazar
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============================================
        // ACCIONES DE CAMAS
        // ============================================

        async function confirmarTraslado(pacienteId) {
            if (!confirm('¬øConfirmar que el paciente lleg√≥ a su cama?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/confirmar-traslado`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Traslado confirmado');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }


        async function aprobarTraslado(pacienteId) {
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/aprobar-traslado`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.exito) {
                        alert('‚úÖ B√∫squeda de cama aprobada e iniciada');
                        cargarDatos();
                    } else {
                        alert('‚ö†Ô∏è ' + data.mensaje);
                        cargarDatos();
                    }
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function rechazarSolicitudTraslado(pacienteId) {
            if (!confirm('¬øCancelar la solicitud de cambio de cama?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/rechazar-traslado`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Solicitud cancelada');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function cancelarTraslado(pacienteId) {
            if (!confirm('¬øCancelar el traslado? El paciente volver√° a lista de espera o a su cama anterior.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/cancelar-traslado`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Traslado cancelado');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ============================================
        // FUNCIONES DE TRASLADO ENTRE CAMAS
        // ============================================

        async function aceptarTraslado(camaId) {
            if (!confirm('¬øConfirmar que el paciente lleg√≥ a esta cama?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/camas/${camaId}/completar-traslado`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Traslado completado exitosamente');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

                async function rechazarTraslado(camaId) {
                    if (!confirm('¬øRechazar este traslado? La cama quedar√° libre y el paciente volver√° a su cama anterior.')) return;
                    
                    try {
                        // Primero obtenemos la informaci√≥n de la cama para saber qu√© paciente est√° en traslado
                        const camasResponse = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/camas`);
                        const camas = await camasResponse.json();
                        const cama = camas.find(c => c.id === camaId);
                        
                        if (!cama || !cama.paciente_id) {
                            alert('‚ùå No se encontr√≥ el paciente en esta cama');
                            return;
                        }
                        
                        // Cancelar el traslado usando el paciente_id
                        const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${cama.paciente_id}/cancelar-traslado`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            alert('‚úÖ Traslado rechazado. El paciente vuelve a su cama anterior.');
                            cargarDatos();
                        } else {
                            const error = await response.json();
                            mostrarError(error);
                        }
                    } catch (error) {
                        alert('‚ùå Error: ' + error.message);
                    }
                }

                async function cancelarTrasladoDesdeOrigen(pacienteId) {
            if (!confirm('¬øCancelar el traslado? El paciente permanecer√° en esta cama y la cama destino se liberar√°.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/cancelar-traslado`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Traslado cancelado. El paciente permanece en su cama actual.');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ============================================
        // ‚úÖ MODIFICADO: Asignaci√≥n autom√°tica de cama
        // ============================================
        
        async function manejarCambioCama(pacienteId) {
            if (!confirm('¬øBuscar y asignar nueva cama autom√°ticamente para este paciente?')) return;
            
            try {
                // Llamar directamente al endpoint de asignaci√≥n autom√°tica
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/buscar-cama-manual`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.exito) {
                        alert(`‚úÖ ${result.mensaje}\n\nCama destino: ${result.cama_destino_id}\nServicio: ${result.servicio_destino}\nSala: ${result.sala_destino}`);
                        cargarDatos();
                    } else {
                        alert(`‚ö†Ô∏è ${result.mensaje}`);
                        cargarDatos();
                    }
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function verDetallesPaciente(pacienteId) {
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes`);
                const pacientes = await response.json();
                const paciente = pacientes.find(p => p.id === pacienteId);
                
                if (!paciente) {
                    alert('‚ùå Paciente no encontrado');
                    return;
                }
                
                const requerimientosMap = {
                    'tratamiento_endovenoso': 'Tratamiento endovenoso',
                    'dolor_intenso': 'Dolor intenso (EVA ‚â•7)',
                    'oxigeno_naricera': 'Ox√≠geno naricera',
                    'oxigeno_mascarilla_multiventuri': 'Ox√≠geno mascarilla multiventuri',
                    'aspiracion_invasiva': 'Aspiraci√≥n invasiva',
                    'irrigacion_vesical': 'Irrigaci√≥n vesical',
                    'drogas_vasoactivas': 'Drogas vasoactivas',
                    'monitorizacion_continua': 'Monitorizaci√≥n continua',
                    'oxigeno_mascarilla_reservorio': 'Ox√≠geno mascarilla reservorio',
                    'oxigeno_cnaf': 'Ox√≠geno CNAF',
                    'oxigeno_vmni': 'Ox√≠geno VMNI',
                    'dialisis_aguda': 'Di√°lisis aguda',
                    'oxigeno_vmi': 'Ox√≠geno VMI',
                    'procuramiento_organos_tejidos': 'Procuramiento de √≥rganos y tejidos',
                    'bic_insulina': 'BIC insulina',
                    'control_examenes_sangre_2mas': 'Control examen sangre 2+',
                    'curaciones_alta_complejidad': 'Curaciones alta complejidad',
                    'kinesioterapia_respiratoria': 'Kinesioterapia respiratoria',
                    'curaciones_heridas': 'Curaciones de heridas',
                    'control_examenes_sangre_1vez': 'Control examen sangre 1 vez'
                };
                
                const requerimientosHTML = paciente.requerimientos.length > 0
                    ? paciente.requerimientos.map(r => `<li>${requerimientosMap[r] || r}</li>`).join('')
                    : '<li class="text-gray-500">Sin requerimientos</li>';
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold mb-4">Detalles del Paciente</h3>
                        <div class="space-y-3">
                            <div><strong>Nombre:</strong> ${paciente.nombre}</div>
                            <div><strong>Sexo:</strong> ${paciente.sexo}</div>
                            <div><strong>Edad:</strong> ${paciente.edad_categoria}</div>
                            <div><strong>Enfermedad:</strong> ${paciente.enfermedad}</div>
                            ${paciente.diagnostico ? `<div><strong>Diagn√≥stico:</strong> ${paciente.diagnostico}</div>` : ''}
                            <div><strong>Aislamiento:</strong> ${paciente.aislamiento}</div>
                            <div><strong>Complejidad:</strong> ${paciente.complejidad_requerida} (${paciente.puntos_complejidad} puntos)</div>
                            ${paciente.es_embarazada ? '<div class="text-pink-600"><strong>‚ö†Ô∏è Paciente embarazada</strong></div>' : ''}
                            ${paciente.es_adulto_mayor ? '<div class="text-yellow-600"><strong>‚ö†Ô∏è Adulto mayor</strong></div>' : ''}
                            ${(paciente.caso_sociosanitario || paciente.espera_cardio) ? `
                                <div class="border-t pt-3 mt-3 bg-purple-100 p-3 rounded">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-4 h-4 bg-purple-600 rounded-full"></div>
                                        <strong class="text-purple-800">CASOS ESPECIALES</strong>
                                    </div>
                                    <div class="text-sm space-y-1">
                                        ${paciente.caso_sociosanitario ? '<div class="text-purple-700">üè• Caso Sociosanitario</div>' : ''}
                                        ${paciente.espera_cardio ? '<div class="text-purple-700">‚ù§Ô∏è En espera de Cardiocirug√≠a</div>' : ''}
                                        <p class="text-xs text-purple-600 mt-2 italic">‚ö†Ô∏è Este paciente NO puede ser dado de alta autom√°ticamente</p>
                                    </div>
                                </div>
                            ` : ''}
                            ${paciente.notas ? `
                                <div class="border-t pt-3 mt-3">
                                    <strong>Notas 
                                        <span class="cursor-help" title="${paciente.notas}">‚Ñπ</span>:
                                    </strong>
                                    <p class="text-sm mt-1 text-gray-600">${paciente.notas}</p>
                                </div>
                            ` : ''}
                            ${paciente.motivo_monitorizacion ? `
                                <div class="border-t pt-3 mt-3 bg-blue-50 p-2 rounded">
                                    <strong class="text-blue-800">Detalles de Monitorizaci√≥n:</strong>
                                    <p class="text-sm mt-1"><strong>Motivo:</strong> ${paciente.motivo_monitorizacion}</p>
                                    ${paciente.signos_monitorizacion ? `<p class="text-sm mt-1"><strong>Signos/S√≠ntomas:</strong> ${paciente.signos_monitorizacion}</p>` : ''}
                                </div>
                            ` : ''}
                            ${paciente.derivacion_pendiente || paciente.motivo_derivacion || paciente.hospital_origen_id ? `
                                <div class="border-t pt-3 mt-3">
                                    <strong class="text-purple-600">üè• Derivaci√≥n:</strong>
                                    ${paciente.hospital_origen_id ? `
                                        <p class="text-sm mt-1"><strong>Desde:</strong> ${getHospitalNombre(paciente.hospital_origen_id)}</p>
                                    ` : ''}
                                    ${paciente.motivo_derivacion ? `
                                        <p class="text-sm mt-1"><strong>Motivo:</strong> ${paciente.motivo_derivacion}</p>
                                    ` : ''}
                                    ${paciente.motivo_rechazo_derivacion ? `
                                        <p class="text-sm mt-1 text-red-600"><strong>‚ö†Ô∏è Rechazado:</strong> ${paciente.motivo_rechazo_derivacion}</p>
                                    ` : ''}
                                    ${paciente.derivacion_pendiente ? `
                                        <p class="text-xs mt-2 text-gray-500 italic">Estado: Pendiente de aceptaci√≥n</p>
                                    ` : ''}
                                </div>
                            ` : ''}
                            <div class="border-t pt-3 mt-3">
                                <strong>Requerimientos Cl√≠nicos:</strong>
                                <ul class="list-disc ml-5 mt-2 text-sm">${requerimientosHTML}</ul>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-6">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                Cerrar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        
        // ‚úÖ NUEVA FUNCI√ìN: Abrir formulario de reevaluaci√≥n
        async function abrirFormularioReevaluacion(pacienteId) {
            try {
                console.log('üîÑ Abriendo formulario de reevaluaci√≥n para:', pacienteId);
                
                // Obtener datos del paciente
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}`);
                if (!response.ok) {
                    throw new Error('No se pudo cargar los datos del paciente');
                }
                
                const paciente = await response.json();
                console.log('Datos del paciente:', paciente);
                
                // Configurar el modal en modo reevaluaci√≥n
                document.getElementById('modal-title').textContent = 'üîÑ Reevaluar Paciente';
                document.getElementById('es-reevaluacion').value = 'true';
                document.getElementById('paciente-id').value = paciente.id;
                
                // Llenar el formulario con los datos actuales
                document.getElementById('nombre').value = paciente.nombre;
                document.getElementById('nombre').disabled = true; // No editable en reevaluaci√≥n
                
                document.getElementById('run').value = paciente.run;
                document.getElementById('run').disabled = true; // No editable en reevaluaci√≥n
                
                // Sexo
                if (paciente.sexo === 'hombre') {
                    document.getElementById('sexo_hombre').checked = true;
                } else {
                    document.getElementById('sexo_mujer').checked = true;
                }
                document.getElementById('sexo_hombre').disabled = true;
                document.getElementById('sexo_mujer').disabled = true;
                
                // Edad
                document.getElementById('edad').value = paciente.edad;
                document.getElementById('edad').disabled = true;
                
                // Embarazada (si aplica)
                if (document.getElementById('es_embarazada')) {
                    document.getElementById('es_embarazada').checked = paciente.es_embarazada || false;
                }
                
                // Diagn√≥stico
                if (document.getElementById('diagnostico')) {
                    document.getElementById('diagnostico').value = paciente.diagnostico || '';
                }
                
                // Tipo de enfermedad (EDITABLE - este es uno de los cambios clave)
                document.getElementById('enfermedad').value = paciente.enfermedad;
                
                // Aislamiento (EDITABLE - este es otro cambio clave)
                document.getElementById('aislamiento').value = paciente.aislamiento;
                
                // Casos especiales (EDITABLES)
                if (document.getElementById('caso_sociosanitario')) {
                    document.getElementById('caso_sociosanitario').checked = paciente.caso_sociosanitario || false;
                }
                if (document.getElementById('espera_cardio')) {
                    document.getElementById('espera_cardio').checked = paciente.espera_cardio || false;
                }
                
                // Requerimientos cl√≠nicos (EDITABLES)
                // Desmarcar todos primero
                document.querySelectorAll('input[name="requerimientos"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                // Marcar los requerimientos actuales
                if (paciente.requerimientos && Array.isArray(paciente.requerimientos)) {
                    paciente.requerimientos.forEach(req => {
                        const checkbox = document.querySelector(`input[name="requerimientos"][value="${req}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
                
                // Campos adicionales
                if (document.getElementById('motivo_monitorizacion')) {
                    document.getElementById('motivo_monitorizacion').value = paciente.motivo_monitorizacion || '';
                }
                if (document.getElementById('signos_monitorizacion')) {
                    document.getElementById('signos_monitorizacion').value = paciente.signos_monitorizacion || '';
                }
                if (document.getElementById('notas')) {
                    document.getElementById('notas').value = paciente.notas || '';
                }
                if (document.getElementById('detalle_procedimiento_invasivo')) {
                    document.getElementById('detalle_procedimiento_invasivo').value = paciente.detalle_procedimiento_invasivo || '';
                }
                
                // ‚úÖ CAMBIO REALIZADO AQU√ç:
                // Antes ocultaba expl√≠citamente la secci√≥n de derivaci√≥n.
                // Ahora nos aseguramos de que est√© visible pero el checkbox desmarcado por defecto.
                // Esto permite derivar durante la reevaluaci√≥n.
                
                const seccionDerivacion = document.getElementById('seccion-derivacion');
                if (seccionDerivacion) {
                    seccionDerivacion.style.display = 'block'; // Asegurar que sea visible
                }
                
                // Resetear estado del checkbox de derivaci√≥n
                const derivacionCheckbox = document.getElementById('derivar-paciente');
                if (derivacionCheckbox) {
                    derivacionCheckbox.checked = false;
                    toggleDerivacion(); // Esto ocultar√° los campos de destino/motivo hasta que se marque el check
                }
                
                cargarHospitalesEnSelector(); // Cargar lista de hospitales para el select de derivaci√≥n

                // Abrir el modal
                openModal('modal-ingresar');
                
            } catch (error) {
                console.error('Error al abrir formulario de reevaluaci√≥n:', error);
                alert('‚ùå Error al cargar datos del paciente: ' + error.message);
            }
        }

        async function aceptarDerivacion(pacienteId) {
            if (!confirm('¬øAceptar este paciente derivado? Se le asignar√° cama autom√°ticamente.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/aceptar-derivacion`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ Derivaci√≥n aceptada. ' + result.mensaje);
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function rechazarDerivacion(pacienteId) {
            // Solicitar motivo de rechazo
            const motivoRechazo = prompt('¬øPor qu√© se rechaza esta derivaci√≥n?\n\nIngrese el motivo:');
            
            if (!motivoRechazo || motivoRechazo.trim() === '') {
                alert('‚ö†Ô∏è Debe ingresar un motivo para rechazar la derivaci√≥n');
                return;
            }
            
            if (!confirm('¬øConfirmar rechazo de derivaci√≥n? El paciente volver√° al hospital de origen.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/rechazar-derivacion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ motivo_rechazo: motivoRechazo })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ Derivaci√≥n rechazada. ' + result.mensaje);
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function confirmarEgreso(pacienteId) {
            if (!confirm('¬øConfirmar el egreso del paciente del hospital? Esto liberar√° la cama.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/confirmar-egreso`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ ' + result.mensaje);
                    // La funci√≥n cargarDatos debe ser s√≠ncrona o no debe llevar 'await'
                    cargarDatos(); 
                } else {
                    const error = await response.json();
                    // Asumiendo que 'mostrarError' es una funci√≥n definida
                    mostrarError(error); 
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ============================================
        // FUNCIONES DE REEVALUACI√ìN Y ALTA
        // ============================================

        async function reevaluarPaciente(pacienteId) {
            try {
                // Obtener datos actuales del paciente
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes`);
                const pacientes = await response.json();
                const paciente = pacientes.find(p => p.id === pacienteId);
                
                if (!paciente) {
                    alert('‚ùå Paciente no encontrado');
                    return;
                }
                
                // Abrir el formulario con los datos del paciente
                document.getElementById('modal-title').textContent = 'Reevaluar Paciente';
                document.getElementById('submit-text').textContent = 'Guardar Reevaluaci√≥n';
                document.getElementById('paciente-id').value = paciente.id;
                document.getElementById('es-reevaluacion').value = 'true';
                
                // Llenar datos b√°sicos (bloqueados)
                document.getElementById('nombre').value = paciente.nombre;
                document.getElementById('nombre').disabled = true;
                document.getElementById('run').value = paciente.run;
                document.getElementById('run').disabled = true;
                document.getElementById('edad').value = paciente.edad;
                document.getElementById('edad').disabled = true;
                
                // Seleccionar sexo (bloqueado)
                if (paciente.sexo === 'hombre') {
                    document.getElementById('sexo_hombre').checked = true;
                } else {
                    document.getElementById('sexo_mujer').checked = true;
                }
                document.getElementById('sexo_hombre').disabled = true;
                document.getElementById('sexo_mujer').disabled = true;
                
                // Llenar enfermedad
                document.getElementById('enfermedad').value = paciente.enfermedad;
                
                // Llenar aislamiento
                document.getElementById('aislamiento').value = paciente.aislamiento || 'ninguno';
                
                // Marcar requerimientos actuales
                document.querySelectorAll('input[name="requerimientos"]').forEach(checkbox => {
                    checkbox.checked = paciente.requerimientos && paciente.requerimientos.includes(checkbox.value);
                });
                
                // Casos especiales
                document.getElementById('caso_sociosanitario').checked = paciente.caso_sociosanitario || false;
                document.getElementById('espera_cardio').checked = paciente.espera_cardio || false;
                
                // Campos adicionales
                document.getElementById('diagnostico').value = paciente.diagnostico || '';
                document.getElementById('motivo_monitorizacion').value = paciente.motivo_monitorizacion || '';
                document.getElementById('signos_monitorizacion').value = paciente.signos_monitorizacion || '';
                document.getElementById('notas').value = paciente.notas || '';
                document.getElementById('detalle_procedimiento_invasivo').value = paciente.detalle_procedimiento_invasivo || '';
                
                // Mostrar/ocultar campos condicionales
                toggleCamposMonitorizacion();
                toggleCamposProcedimientoInvasivo();
                toggleEmbarazada();
                
                // ‚úÖ MOSTRAR secci√≥n de derivaci√≥n en reevaluaci√≥n
                const seccionDerivacion = document.getElementById('seccion-derivacion');
                if (seccionDerivacion) {
                    seccionDerivacion.style.display = 'block'; // Mostrar la secci√≥n
                }
                
                // Resetear estado del checkbox de derivaci√≥n
                const derivacionCheckbox = document.getElementById('derivar-paciente');
                if (derivacionCheckbox) {
                    derivacionCheckbox.checked = false;
                    toggleDerivacion(); // Esto ocultar√° los campos de destino/motivo hasta que se marque el check
                }
                
                // Cargar lista de hospitales para el select de derivaci√≥n
                cargarHospitalesEnSelector();
                
                // Abrir modal
                openModal('modal-ingresar');
                
            } catch (error) {
                alert('‚ùå Error al cargar datos del paciente: ' + error.message);
            }
        }

        async function sugerirAlta(camaId) {
            if (!confirm('¬øSugerir alta para este paciente? La cama quedar√° marcada como candidata para alta.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/camas/${camaId}/sugerir-alta`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Alta sugerida. La cama est√° marcada para revisi√≥n.');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function confirmarAlta(camaId) {
            if (!confirm('¬øConfirmar el alta del paciente?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/camas/${camaId}/alta`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Alta confirmada');
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function cancelarAlta(camaId) {
            if (!confirm('¬øCancelar o revertir el alta sugerida?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/camas/${camaId}/cancelar-alta`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ ' + result.mensaje);
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function asignarCamasAutomaticamente() {
            if (!confirm('¬øAsignar camas autom√°ticamente a los pacientes en espera?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/asignar-camas`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`‚úÖ ${data.mensaje}`);
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ============================================
        // FORMULARIO DE PACIENTES
        // ============================================

        async function asignarCamaIndividual(pacienteId) {
            if (!confirm('¬øBuscar y asignar cama para este paciente?')) return;

            try {
                const response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/asignar-cama-local`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ ${result.mensaje}`);
                    cargarDatos();
                } else {
                    const error = await response.json();
                    alert('‚ùå Error: ' + error.detail);
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        async function submitPacienteForm(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const esReevaluacion = formData.get('es_reevaluacion') === 'true';
            const pacienteId = formData.get('paciente_id');
            const derivarChecked = document.getElementById('derivar-paciente').checked;
            
            const requerimientos = [];
            formData.getAll('requerimientos').forEach(req => requerimientos.push(req));
            
            const data = {
                nombre: formData.get('nombre'),
                run: formData.get('run'),
                sexo: formData.get('sexo'),
                edad: parseInt(formData.get('edad')),  // Edad num√©rica
                edad_categoria: formData.get('edad_categoria') || 'adulto',  // Por compatibilidad
                enfermedad: formData.get('enfermedad'),
                aislamiento: formData.get('aislamiento'),
                es_embarazada: formData.get('es_embarazada') === 'on',
                es_adulto_mayor: formData.get('es_adulto_mayor') === 'on',
                caso_sociosanitario: formData.get('caso_sociosanitario') === 'on',
                espera_cardio: formData.get('espera_cardio') === 'on',
                requerimientos: requerimientos,
                diagnostico: formData.get('diagnostico') || null,
                motivo_monitorizacion: formData.get('motivo_monitorizacion') || null,
                signos_monitorizacion: formData.get('signos_monitorizacion') || null,
                notas: formData.get('notas') || null,
                detalle_procedimiento_invasivo: formData.get('detalle_procedimiento_invasivo') || null
            };
            
            try {
                let response;
                let esDrivacion = false;
                
                if (esReevaluacion) {
                    // Reevaluaci√≥n completa (enfermedad, aislamiento, casos especiales, requerimientos)
                    response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${pacienteId}/reevaluar`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            enfermedad: formData.get('enfermedad'),
                            aislamiento: formData.get('aislamiento'),
                            caso_sociosanitario: formData.get('caso_sociosanitario') === 'on',
                            espera_cardio: formData.get('espera_cardio') === 'on',
                            requerimientos: requerimientos,
                            diagnostico: formData.get('diagnostico') || null,
                            motivo_monitorizacion: formData.get('motivo_monitorizacion') || null,
                            signos_monitorizacion: formData.get('signos_monitorizacion') || null,
                            notas: formData.get('notas') || null,
                            detalle_procedimiento_invasivo: formData.get('detalle_procedimiento_invasivo') || null
                        })
                    });
                } else {
                    // Nuevo paciente
                    response = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/ingresar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    const nuevoPacienteId = result.paciente?.id || pacienteId;
                    
                    // Si se marc√≥ derivaci√≥n, derivar al paciente
                    if (derivarChecked) {
                        const hospitalDestino = formData.get('hospital_destino');
                        const motivoDerivacion = formData.get('motivo_derivacion');
                        
                        if (!hospitalDestino || !motivoDerivacion) {
                            alert('‚ö†Ô∏è Debe completar todos los campos de derivaci√≥n');
                            return;
                        }
                        
                        const derivacionResponse = await fetch(`${API_BASE}/hospitales/${HOSPITAL_ID}/pacientes/${nuevoPacienteId}/derivar`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                hospital_destino_id: hospitalDestino,
                                motivo_derivacion: motivoDerivacion
                            })
                        });
                        
                        if (derivacionResponse.ok) {
                            const derivResult = await derivacionResponse.json();
                            alert(`‚úÖ Paciente ${esReevaluacion ? 'reevaluado y ' : ''}derivado a ${derivResult.hospital_destino}`);
                        } else {
                            const errorDeriv = await derivacionResponse.json();
                            mostrarError(errorDeriv);
                            return;
                        }
                    } else {
                        alert(esReevaluacion ? '‚úÖ Paciente reevaluado. Sistema buscando nueva cama...' : '‚úÖ Paciente registrado');
                    }
                    
                    closeModal('modal-ingresar');
                    form.reset();
                    document.getElementById('derivar-paciente').checked = false;
                    toggleDerivacion();
                    cargarDatos();
                } else {
                    const error = await response.json();
                    mostrarError(error);
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }

        // ============================================
        // MODALES
        // ============================================

        function limpiarFormularioPaciente() {
            // Limpiar completamente el formulario
            document.getElementById('form-paciente').reset();
            document.getElementById('modal-title').textContent = 'Registrar Nuevo Paciente';
            document.getElementById('submit-text').textContent = 'Registrar Paciente';
            document.getElementById('paciente-id').value = '';
            document.getElementById('es-reevaluacion').value = 'false';
            document.getElementById('nombre').disabled = false;
            document.getElementById('run').disabled = false;  // Habilitar RUN para nuevo paciente
            document.getElementById('edad').disabled = false;  // Habilitar edad para nuevo paciente
            
            // Habilitar radio buttons de sexo
            document.getElementById('sexo_hombre').disabled = false;
            document.getElementById('sexo_mujer').disabled = false;
            
            // Desmarcar todos los checkboxes
            document.querySelectorAll('input[name="requerimientos"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Resetear derivaci√≥n
            document.getElementById('derivar-paciente').checked = false;
            toggleDerivacion();
            
            // Mostrar secci√≥n de derivaci√≥n (en caso de que se haya ocultado en reevaluaci√≥n)
            const seccionDerivacion = document.getElementById('seccion-derivacion');
            if (seccionDerivacion) {
                seccionDerivacion.style.display = 'block';
            }
        }

        function abrirFormularioNuevoPaciente() {
            limpiarFormularioPaciente();
            cargarHospitalesEnSelector();  // Cargar lista de hospitales
            toggleEmbarazada();  // Inicializar visibilidad de embarazada
            openModal('modal-ingresar');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        // Inicializar event listeners para requerimientos
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners para requerimientos
            const requerimientosCheckboxes = document.querySelectorAll('input[name="requerimientos"]');
            requerimientosCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    toggleCamposMonitorizacion();
                    toggleCamposProcedimientoInvasivo();
                });
            });
            
            // Event listeners para radio buttons de sexo
            const sexoRadios = document.querySelectorAll('input[name="sexo"]');
            sexoRadios.forEach(radio => {
                radio.addEventListener('change', toggleEmbarazada);
            });
        });

        // Cargar datos al inicio
        cargarDatos();

        // Actualizar cada 5 segundos
        setInterval(cargarDatos, 5000);
    </script>
</body>
</html>